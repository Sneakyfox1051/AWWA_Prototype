<!DOCTYPE html>
<html lang="en">
<head>
    <!--
    ===========================================
    AWWA FAMILY MANAGEMENT SYSTEM - SUPER USER DASHBOARD
    ===========================================
    
    PURPOSE: Enhanced dashboard with advanced features for super users and administrators
    TARGET USERS: Super users (L1 level) and administrators with elevated privileges
    FEATURES:
    - All features from main dashboard PLUS:
    - Advanced analytics and reporting capabilities
    - Enhanced data visualization with additional chart types
    - Super user specific navigation and controls
    - Advanced user management features
    - Enhanced Power BI integration
    - Extended D-ID chatbot capabilities
    
    DIFFERENCES FROM MAIN DASHBOARD:
    - Additional chart types and analytics
    - Enhanced navigation with super user specific sections
    - Advanced data processing capabilities
    - Extended user profile management
    - Enhanced security and access controls
    
    DATA SOURCE: Same as main dashboard (624 EME BN Excel file)
    - 274 total families across 7 workshop units
    - 183 total children with detailed records
    - 5 women registered for AWWA entrepreneurship program
    - Comprehensive health, education, and demographic data
    
    DEPENDENCIES:
    - dashboard.css: Main stylesheet for dashboard styling
    - Chart.js: Interactive charts and data visualization
    - Font Awesome: Icons and UI elements
    - Tailwind CSS: Responsive design framework
    - XLSX library: Excel file processing
    - D-ID Agent: AI chatbot integration
    
    NAVIGATION FLOW:
    login.html → dashboard_super user.html (this file)
    logout → login.html
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AWWA - Dashboard Home</title>
    <link rel="stylesheet" href="dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Tailwind CSS for enhanced charts -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Inter font family -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- D-ID Agent Chatbot - Badi Didi -->
    <script type="module"
          src="https://agent.d-id.com/v2/index.js"
          data-mode="fabio"
          data-client-key="Z29vZ2xlLW9hdXRoMnwxMDA1MjIwMjc4MDA4MjIzNDk5MDE6aDEyZUd2MFNUa2gzWkRhWG0ybjA2"
          data-agent-id="v2_agt_CKSD5djL"
          data-name="did-agent"
          data-monitor="true"
          data-orientation="horizontal"
          data-position="right">
    </script>
    
    <style>
        /* Enhanced Charts Styles */
        .enhanced-charts-section {
            margin-bottom: 40px;
        }

        .section-subtitle {
            font-size: 24px;
            font-weight: 700;
            color: #1F2937;
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--brand-primary);
            display: inline-block;
            width: 100%;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .enhanced-chart-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .enhanced-chart-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Removed large class - all charts now equal width */

        /* Children section specific grid layout */
        .children-charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .children-charts-grid .enhanced-chart-card:nth-child(4),
        .children-charts-grid .enhanced-chart-card:nth-child(5) {
            grid-column: span 1;
        }

        /* Families Grid Layout */
        .families-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        /* Mobile Navigation Toggle - TO BE FIXED BY JYOTI */
        /* Current implementation has issues with visibility and functionality */
        .nav-toggle {
            display: none;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #374151;
            font-size: 16px;
            cursor: pointer;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            width: 100%;
            text-align: left;
            transition: all 0.3s ease;
        }

        .nav-toggle:hover {
            background: #e9ecef;
            color: var(--brand-primary);
        }

        .nav-toggle i {
            margin-right: 8px;
            transition: transform 0.3s ease;
        }

        .nav-toggle.active i {
            transform: rotate(180deg);
        }

        .lp-nav {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .lp-nav.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        .lp-nav.expanded {
            max-height: 500px;
            opacity: 1;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .large-chart-container {
            position: relative;
            height: 500px;
            width: 100%;
        }

        .small-chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .modal-overlay {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(5px);
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: 99999 !important;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            
            .modal-overlay:not(.hidden) {
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            .modal-overlay.hidden {
                opacity: 0 !important;
                visibility: hidden !important;
            }
            
            .modal-container {
                background: white !important;
                border-radius: 20px !important;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
                max-width: 900px !important;
                width: 90% !important;
                max-height: 90vh !important;
                overflow: hidden !important;
                transform: scale(0.9) translateY(20px) !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                margin: 20px !important;
            }
            
            .modal-overlay:not(.hidden) .modal-container {
                transform: scale(1) translateY(0) !important;
            }
            
            .modal-header {
                background: linear-gradient(135deg, #ff8c00 0%, #ff7f00 100%);
                color: white;
                padding: 25px 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
                overflow: hidden;
            }
            
            .modal-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%, rgba(255, 255, 255, 0.1) 100%);
                pointer-events: none;
            }
            
            .modal-title {
                display: flex;
                align-items: center;
                gap: 12px;
                position: relative;
                z-index: 1;
            }
            
            .modal-title i {
                font-size: 24px;
                background: rgba(255, 255, 255, 0.2);
                padding: 12px;
                border-radius: 12px;
                backdrop-filter: blur(10px);
            }
            
            .modal-title h3 {
                margin: 0;
                font-size: 24px;
                font-weight: 700;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .modal-close-btn {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                backdrop-filter: blur(10px);
                position: relative;
                z-index: 1;
            }
            
            .modal-close-btn:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: scale(1.1);
            }
            
            .modal-body {
                padding: 0;
                max-height: calc(90vh - 100px);
                overflow-y: auto;
            }
            
            .add-family-form {
                padding: 30px;
            }

        /* Tablet Responsive Design */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .children-charts-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .families-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .enhanced-chart-card.large {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            /* Main Layout */
            .dash-layout {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                height: auto;
                position: relative;
                padding: 16px;
            }
            
            .main-area {
                width: 100%;
                padding: 16px;
            }
            
            /* Header */
            .app-header {
                padding: 12px 16px;
            }
            
            .app-title {
                font-size: 16px;
            }
            
            .logout-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
    /* Left Panel */
    .lp-header {
        flex-direction: column;
        text-align: center;
        padding: 16px;
    }
    
    .lp-name {
        font-size: 16px;
        margin: 8px 0 4px 0;
    }
    
    .lp-role {
        font-size: 12px;
    }
    
    /* Navigation Toggle */
    .nav-toggle {
        display: block !important;
        width: 100%;
        text-align: left;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin: 8px 0;
        padding: 12px 16px;
        font-size: 16px;
        color: #374151;
        cursor: pointer;
    }
    
    .lp-nav {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        margin: 0;
        padding: 0;
    }
    
    .lp-nav.expanded {
        max-height: 500px;
        opacity: 1;
        margin: 8px 0;
        padding: 8px 0;
    }
    
    .lp-nav ul {
        flex-direction: column;
        gap: 4px;
        padding: 8px 0;
    }
    
    .lp-nav li {
        width: 100%;
        text-align: left;
        padding: 12px 16px;
        border-radius: 8px;
        background: #f8f9fa;
        margin: 2px 0;
    }
    
    .lp-nav li:hover {
        background: #e9ecef;
    }
    
    .lp-nav li i {
        font-size: 16px;
        margin-right: 12px;
        width: 20px;
    }
    
    .lp-nav li span {
        font-size: 14px;
    }
            
            /* Welcome Section */
            .welcome-section-card {
                padding: 16px;
            }
            
            .welcome-title {
                font-size: 24px;
                margin-bottom: 16px;
            }
            
            .user-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .panel-card {
                padding: 16px;
            }
            
            .panel-header h3 {
                font-size: 16px;
            }
            
            .profile-side-card {
                padding: 16px;
                text-align: center;
            }
            
            /* Stats Cards */
            .stats-card-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin: 16px 0;
            }
            
            .stat-mini-card {
                padding: 12px;
            }
            
            .mini-value {
                font-size: 20px;
            }
            
            .mini-content small {
                font-size: 11px;
            }
            
            /* Charts */
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .children-charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            /* All charts now equal width */
            
            .chart-container {
                height: 300px;
            }
            
            .large-chart-container {
                height: 350px;
            }
            
            .enhanced-chart-card {
                padding: 16px;
            }
            
            .section-subtitle {
                font-size: 18px;
                margin-bottom: 20px;
            }
            
            /* Families Section */
            .families-actions {
                flex-direction: column;
                gap: 8px;
            }

            .families-actions .check-btn {
                display: flex;
                align-items: center;
                gap: 6px;
            }
            .add-family-form {
                    padding: 20px;
                }
                
                .form-row {
                    grid-template-columns: 1fr;
                    gap: 15px;
                }
                
                .form-actions {
                    flex-direction: column;
                    gap: 15px;
                }
                
                .btn-primary,
                .btn-secondary {
                    width: 100%;
                    justify-content: center;
                }
            }

        .families-actions .check-btn i {
            font-size: 14px;
        }

        .workshop-filter {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: #374151;
            min-width: 150px;
        }

        .workshop-filter:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
            
            /* Modal Popup Styling */
            .modal-overlay {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(5px);
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: 99999 !important;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            
            .modal-overlay:not(.hidden) {
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            .modal-overlay.hidden {
                opacity: 0 !important;
                visibility: hidden !important;
            }
            
            .modal-container {
                background: white !important;
                border-radius: 20px !important;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
                max-width: 900px !important;
                width: 90% !important;
                max-height: 90vh !important;
                overflow: hidden !important;
                transform: scale(0.9) translateY(20px) !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                margin: 20px !important;
            }
            
            .modal-overlay:not(.hidden) .modal-container {
                transform: scale(1) translateY(0) !important;
            }
            
            .modal-header {
                background: linear-gradient(135deg, #ff8c00 0%, #ff7f00 100%);
                color: white;
                padding: 25px 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
                overflow: hidden;
            }
            
            .modal-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%, rgba(255, 255, 255, 0.1) 100%);
                pointer-events: none;
            }
            
            .modal-title {
                display: flex;
                align-items: center;
                gap: 12px;
                position: relative;
                z-index: 1;
            }
            
            .modal-title i {
                font-size: 24px;
                background: rgba(255, 255, 255, 0.2);
                padding: 12px;
                border-radius: 12px;
                backdrop-filter: blur(10px);
            }
            
            .modal-title h3 {
                margin: 0;
                font-size: 24px;
                font-weight: 700;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .modal-close-btn {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                backdrop-filter: blur(10px);
                position: relative;
                z-index: 1;
            }
            
            .modal-close-btn:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: scale(1.1);
            }
            
            .modal-body {
                padding: 0;
                max-height: calc(90vh - 100px);
                overflow-y: auto;
            }
            
            .add-family-form {
                padding: 30px;
            }
            
            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }
            
            .form-group {
                display: flex;
                flex-direction: column;
            }
            
            .form-group.full-width {
                grid-column: 1 / -1;
            }
            
            .form-group label {
                font-weight: 600;
                color: #374151;
                margin-bottom: 6px;
                font-size: 14px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px 16px;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                font-size: 14px;
                transition: all 0.3s ease;
                background: #fafafa;
                font-family: inherit;
            }
            
            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: #ff8c00;
                box-shadow: 0 0 0 4px rgba(255, 140, 0, 0.1);
                background: white;
                transform: translateY(-1px);
            }
            
            .form-group input[required] {
                border-color: #ff8c00;
                background: linear-gradient(135deg, #fff5e6 0%, #ffffff 100%);
            }
            
            .form-group input[required]:focus {
                background: white;
                box-shadow: 0 0 0 4px rgba(255, 140, 0, 0.15);
            }
            
            .form-section-header {
                margin: 40px 0 25px 0;
                padding: 20px 0 15px 0;
                border-bottom: 3px solid #ff8c00;
                background: linear-gradient(135deg, #fff5e6 0%, #ffffff 100%);
                border-radius: 12px;
                padding: 20px;
                position: relative;
                overflow: hidden;
            }
            
            .form-section-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, rgba(255, 140, 0, 0.05) 0%, transparent 50%, rgba(255, 140, 0, 0.05) 100%);
                pointer-events: none;
            }
            
            .form-section-header h4 {
                color: #ff8c00;
                font-size: 20px;
                font-weight: 700;
                margin: 0;
                position: relative;
                z-index: 1;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .form-section-header h4::before {
                content: '●';
                color: #ff8c00;
                font-size: 16px;
            }
            
            .form-actions {
                display: flex;
                gap: 20px;
                justify-content: flex-end;
                margin-top: 40px;
                padding: 25px 0 10px 0;
                border-top: 2px solid #ff8c00;
                background: linear-gradient(135deg, #fff5e6 0%, #ffffff 100%);
                margin: 40px -30px 0 -30px;
                padding: 25px 30px;
            }
            
            .btn-primary,
            .btn-secondary {
                padding: 14px 28px;
                border-radius: 12px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 16px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                position: relative;
                overflow: hidden;
            }
            
            .btn-primary {
                background: linear-gradient(135deg, #ff8c00 0%, #ff7f00 100%);
                color: white;
                border: none;
                box-shadow: 0 4px 15px rgba(255, 140, 0, 0.3);
            }
            
            .btn-primary:hover {
                background: linear-gradient(135deg, #ff7f00 0%, #e67300 100%);
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(255, 140, 0, 0.4);
            }
            
            .btn-primary:active {
                transform: translateY(0);
                box-shadow: 0 4px 15px rgba(255, 140, 0, 0.3);
            }
            
            .btn-secondary {
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                color: #6b7280;
                border: 2px solid #d1d5db;
            }
            
            .btn-secondary:hover {
                background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
                border-color: #9ca3af;
                color: #374151;
                transform: translateY(-1px);
            }

            
            
            /* Desktop Modal Styling */
            @media (min-width: 769px) {

                .modal-overlay {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(5px);
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: 99999 !important;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            
            .modal-overlay:not(.hidden) {
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            .modal-overlay.hidden {
                opacity: 0 !important;
                visibility: hidden !important;
            }
            
            .modal-container {
                background: white !important;
                border-radius: 20px !important;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
                max-width: 900px !important;
                width: 90% !important;
                max-height: 90vh !important;
                overflow: hidden !important;
                transform: scale(0.9) translateY(20px) !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                margin: 20px !important;
            }
            
            .modal-overlay:not(.hidden) .modal-container {
                transform: scale(1) translateY(0) !important;
            }
            
            .modal-header {
                background: linear-gradient(135deg, #ff8c00 0%, #ff7f00 100%);
                color: white;
                padding: 25px 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
                overflow: hidden;
            }
            
            .modal-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%, rgba(255, 255, 255, 0.1) 100%);
                pointer-events: none;
            }
            
            .modal-title {
                display: flex;
                align-items: center;
                gap: 12px;
                position: relative;
                z-index: 1;
            }
            
            .modal-title i {
                font-size: 24px;
                background: rgba(255, 255, 255, 0.2);
                padding: 12px;
                border-radius: 12px;
                backdrop-filter: blur(10px);
            }
            
            .modal-title h3 {
                margin: 0;
                font-size: 24px;
                font-weight: 700;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .modal-close-btn {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                backdrop-filter: blur(10px);
                position: relative;
                z-index: 1;
            }
            
            .modal-close-btn:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: scale(1.1);
            }
            
            .modal-body {
                padding: 0;
                max-height: calc(90vh - 100px);
                overflow-y: auto;
            }
            
            .add-family-form {
                padding: 30px;
            }
                .modal-overlay {
                    z-index: 10000;
                }
                
                .modal-container {
                    max-width: 1000px;
                    width: 85%;
                    margin: 40px auto;
                }
                
                .modal-body {
                    max-height: calc(90vh - 120px);
                }
                
                .form-row {
                    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                    gap: 25px;
                }
            }
            
            /* Mobile Responsiveness for Modal */
            @media (max-width: 768px) {
                .modal-container {
                    width: 95%;
                    max-height: 95vh;
                    margin: 20px;
                }
                
                .modal-header {
                    padding: 20px;
                }
                
                .modal-title h3 {
                    font-size: 20px;
                }
                
                .add-family-form {
                    padding: 20px;
                }
                
                .form-row {
                    grid-template-columns: 1fr;
                    gap: 15px;
                }
                
                .form-actions {
                    flex-direction: column;
                    gap: 15px;
                }
                
                .btn-primary,
                .btn-secondary {
                    width: 100%;
                    justify-content: center;
                }
            }

        .families-actions .check-btn i {
            font-size: 14px;
        }

        .workshop-filter {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: #374151;
            min-width: 150px;
        }

        .workshop-filter:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Header Layout - TO BE FIXED BY JYOTI */
        /* Current implementation not working - needs proper CSS for header positioning */
        /*
        .app-header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .app-brand {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .app-title-wrap {
            margin-left: 12px;
        }

        .app-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }

        .logout-btn {
            margin-left: auto;
        }
        */

            .no-data-message {
                text-align: center;
                padding: 40px 20px;
                color: #6b7280;
            }

            .no-data-message i {
                font-size: 48px;
                margin-bottom: 16px;
                color: #d1d5db;
            }

            .no-data-message p {
                font-size: 16px;
                margin: 0;
            }
            
            .fam-search {
                width: 100%;
            }
            
            .families-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .family-card {
                padding: 12px;
            }
            
            /* Newsletter Section */
            .newsletter-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .newsletter-form {
                padding: 16px;
            }
            
            /* Rankings Section */
            .ranking-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .rank-card {
                padding: 12px;
        }
        

        @media (max-width: 480px) {
            /* Extra Small Mobile */
            .app-title {
                font-size: 14px;
            }
            
            .welcome-title {
                font-size: 20px;
            }
            
            .stats-card-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .stat-mini-card {
                padding: 8px;
            }
            
            .mini-value {
                font-size: 18px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .large-chart-container {
                height: 300px;
            }
            
            .enhanced-chart-card {
                padding: 12px;
            }
            
            .section-subtitle {
                font-size: 16px;
            }
            
            .lp-nav li {
                min-width: 100px;
                padding: 6px 2px;
            }
            
            .lp-nav li span {
                font-size: 10px;
            }
            .profile-side-card{
                display:none;
            }
        }

        /* Family Detail Modal Styling */
        .family-detail-modal {
            max-width: 1000px !important;
            width: 95% !important;
        }
        
        .family-detail-body {
            padding: 0 !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
        }
        
        .family-detail-content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .family-detail-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        .family-detail-section h4 {
            color: #1e293b;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #ff8c00;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .family-detail-section h4 i {
            color: #ff8c00;
            font-size: 20px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: #64748b;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 120px;
        }
        
        .detail-value {
            color: #1e293b;
            font-weight: 500;
            font-size: 15px;
            text-align: right;
            flex: 1;
            margin-left: 20px;
        }
        
        .detail-value.highlight {
            color: #ff8c00;
            font-weight: 700;
        }
        
        .family-photo {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #ff8c00 0%, #ff7f00 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .family-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ff8c00 0%, #ff7f00 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.3);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .contact-info {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f8fafc;
            border-radius: 8px;
            color: #64748b;
            font-size: 14px;
        }
        
        .contact-item i {
            color: #ff8c00;
        }
        
        /* Family Card Clickable Styling */
        .family-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .family-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .family-card:active {
            transform: translateY(-2px);
        }
        
        /* Mobile Responsive for Family Detail Modal */
        @media (max-width: 768px) {
            .family-detail-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .family-detail-section {
                padding: 20px;
            }
            
            .detail-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .detail-value {
                text-align: left;
                margin-left: 0;
            }
            
            .family-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .contact-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="app-header-inner">
            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="app-brand">
                <img src="public/Untitled design (27).png" alt="AWWA Logo" class="app-logo" />
                <div class="app-title-wrap">
                    <h1 class="app-title">Ranbankura Eagles : AWWA Centralised Information Hub</h1>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </header>
    
    <!-- Mobile Navigation Popup -->
    <div id="mobileNavPopup" class="mobile-nav-popup hidden">
        <div class="mobile-nav-overlay" onclick="closeMobileMenu()"></div>
        <div class="mobile-nav-content">
            <div class="mobile-nav-header">
                <h3>Navigation Menu</h3>
                <button class="mobile-nav-close" onclick="closeMobileMenu()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="mobile-nav-menu">
                <ul>
                    <li class="mobile-nav-item active" data-target="section-dashboard" onclick="navigateToSection('section-dashboard')">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </li>
                    <li class="mobile-nav-item" data-target="section-families" onclick="navigateToSection('section-families')">
                        <i class="fas fa-notes-medical"></i>
                        <span>Families</span>
                    </li>
                    <li class="mobile-nav-item" data-target="section-companies" onclick="navigateToSection('section-companies')">
                        <i class="fas fa-building"></i>
                        <span>FW Coy</span>
                    </li>
                    <li class="mobile-nav-item" data-target="section-Newsletter" onclick="navigateToSection('section-Newsletter')">
                        <i class="fas fa-calendar"></i>
                        <span>Newsletter</span>
                    </li>
                    <li class="mobile-nav-item" data-target="section-Rankings" onclick="navigateToSection('section-Rankings')">
                        <i class="fas fa-chart-bar"></i>
                        <span>Unit Rankings</span>
                    </li>
                    <li class="mobile-nav-item" data-target="section-settings" onclick="navigateToSection('section-settings')">
                        <i class="fas fa-gear"></i>
                        <span>Settings</span>
                    </li>
                </ul>
        </div>
    </div>
    
    <div class="dash-layout">
        <!-- Left Side Panel -->
        <aside class="left-panel">

            <div class="lp-header">
                <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <img src="public/profile.png" alt="Profile" class="lp-avatar-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                <div class="lp-avatar" style="display:none;">TS</div>
                <div class="lp-name">Col Tarunpreet Singh</div>
                <div class="lp-role">Commanding Officer</div>
            </div>
            
            <!-- Navigation Toggle Button - TO BE FIXED BY JYOTI -->
            <!-- Current implementation has issues with visibility and functionality -->
            
            <nav class="lp-nav" id="lpNav">
                <ul>
                    <li class="active" data-target="section-dashboard"><i class="fas fa-home"></i><span>Dashboard</span></li>
                    <li data-target="section-families"><i class="fas fa-notes-medical"></i><span>Families</span></li>
                    <li data-target="section-companies"><i class="fas fa-building"></i><span>FW Coy</span></li>
                    <li data-target="section-Newsletter"><i class="fas fa-calendar"></i><span>Newsletter</span></li>
                    <li data-target="section-Rankings"><i class="fas fa-chart-bar"></i><span>Unit Rankings</span></li>
                </ul>
            </nav>
            
        </aside>

        <!-- Main Area -->
        <div class="main-area">
    <div class="home-container app-section" id="section-dashboard">
        <!-- Welcome Header Row -->
        <section class="welcome-section-card">
            <h1 class="welcome-title" id="welcomeTitle">Welcome!</h1>

            <div class="user-grid">
                <!-- User Information -->
                <div class="panel-card">
                    <div class="panel-header">
                        <i class="fas fa-user-circle"></i>
                        <h3>User Information</h3>
                    </div>
                    <div class="panel-body" id="userInfoBody">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>

                <!-- Additional Details -->
                <div class="panel-card">
                    <div class="panel-header">
                        <i class="fas fa-circle-info"></i>
                        <h3 id="additionalDetailsTitle">Additional Details</h3>
                        <div class="panel-header-image" id="additionalDetailsImage" style="display: none;">
                            <img src="" alt="Wife Image" id="wifeImage" />
                    </div>
                    </div>
                    <div class="panel-body" id="additionalDetailsBody">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>

                <!-- Profile Card -->
                <div class="profile-side-card">
                    <img src="public/profile.png" alt="Profile" class="avatar-box-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                    <div class="avatar-box" style="display:none;" id="profileInitials">SB</div>
                    <i class="fas fa-check-circle verified"></i>
                    <div class="profile-meta">
                        <h4 id="profileName">Loading...</h4>
                        <p id="profileDesignation">Loading...</p>
                    </div>
                </div>
            </div>
        </section>

                <!-- Stats Cards -->
                <div class="stats-card-grid">
                    <div class="stat-mini-card">
                        <div class="mini-icon"><i class="fas fa-users"></i></div>
                        <div class="mini-content">
                            <div class="mini-value" id="totalFamiliesVal">274</div>
                            <small>Total Families</small>
                </div>
            </div>
            
                 <div class="stat-mini-card">
                        <div class="mini-icon"><i class="fas fa-child"></i></div>
                        <div class="mini-content">
                            <div class="mini-value" id="totalChildrenVal">509</div>
                            <small>Total Children</small>
                            <div class="gender-breakdown">
                                <div class="male-heading">Male: 356</div>
                                <div class="female-heading">Female: 153</div>
                    </div>
                        </div>
                        </div>
                    <div class="stat-mini-card">
                        <div class="mini-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="mini-content">
                            <div class="mini-value" id="registeredFamiliesVal">2</div>
                            <small>IVF Cases</small>
                        </div>
                        </div>
                    <div class="stat-mini-card">
                        <div class="mini-icon"><i class="fas fa-calculator"></i></div>
                        <div class="mini-content">
                            <div class="mini-value" id="avgChildrenVal">1</div>
                            <small>Special Child</small>
                    </div>
                </div>
                    <div class="stat-mini-card">
                        <div class="mini-icon"><i class="fas fa-heart-broken"></i></div>
                        <div class="mini-content">
                            <div class="mini-value" id="maritalDiscordVal">2</div>
                            <small>Marital Discord Cases</small>
                    </div>
                        </div>
                    <!-- 
                    ===========================================
                    REFRESH DATA FUNCTIONALITY - TEAM DISCUSSION REQUIRED
                    ===========================================
                    
                    TODO: Discuss with team before implementing in production
                    
                    This refresh button allows users to manually update data from Google Sheets.
                    Consider the following for team discussion:
                    
                    1. SECURITY CONCERNS:
                       - CORS proxy usage (api.allorigins.win) - is this acceptable?
                       - Data privacy when using third-party proxies
                       - Rate limiting and abuse prevention
                    
                    2. PERFORMANCE IMPACT:
                       - Manual refresh vs automatic refresh (currently 5 minutes)
                       - Server load if many users refresh simultaneously
                       - Caching strategy for frequently accessed data
                    
                    3. USER EXPERIENCE:
                       - Should refresh be available to all user types?
                       - Loading states and user feedback
                       - Error handling and fallback messages
                    
                    4. ALTERNATIVE SOLUTIONS:
                       - Server-side data fetching
                       - WebSocket for real-time updates
                       - API integration instead of CSV export
                       - Database backend instead of Google Sheets
                    
                    5. PRODUCTION CONSIDERATIONS:
                       - Remove or modify for production deployment
                       - Implement proper authentication for data access
                       - Add data validation and sanitization
                       - Consider data backup and recovery
                    
                    CURRENT STATUS: Development/Testing Only
                    -->
                    <div class="stat-mini-card">
                        <div class="mini-icon"><i class="fas fa-sync-alt"></i></div>
                        <div class="mini-content">
                            <button id="refreshDataBtn" class="refresh-btn" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt"></i> Refresh Dashboard
                            </button>
                            <small id="dataStatus">Static Data</small>
                    </div>
                        </div>
                    <div class="stat-mini-card">
                        <div class="mini-icon"><i class="fas fa-user-injured"></i></div>
                        <div class="mini-content">
                            <div class="mini-value" id="otherMedicalVal">2</div>
                            <small>Other Critical Medical Cases</small>
                        </div>
                        </div>
                    <div class="stat-mini-card">
                        <div class="mini-icon"><i class="fas fa-child"></i></div>
                        <div class="mini-content">
                            <div class="mini-value" id="childrenAgeVal">509</div>
                            <small>Children Age Profile</small>
                            <div class="age-breakdown-single">
                                <div class="age-group">0-6: 122</div>
                                <div class="age-group">6-12: 216</div>
                                <div class="age-group">12-18: 150</div>
                                <div class="age-group">18-24: 20</div>
                        </div>
                    </div>
                </div>
            </div>
            
                <!-- Enhanced Family Data Charts -->
                <div class="enhanced-charts-section">
                    <h3 class="section-subtitle">Family-Related Analytics</h3>
                    <div class="charts-grid">
                        <!-- Chart 1: Medical Status - Doughnut Chart -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="medicalStatusChart"></canvas>
                        </div>
                            </div>
                    
                        <!-- Chart 2: Parental Education - Horizontal Bar Chart -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="educationChart"></canvas>
                        </div>
                    </div>
                    
                        <!-- Chart 3: Marital Discord - Progress Ring -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="maritalDiscordChart"></canvas>
                        </div>
                            </div>
                    
                        <!-- Chart 4: Workshop Distribution - Bar Chart -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="workshopChart"></canvas>
                        </div>
                    </div>
                    
                        <!-- Chart 5: Entrepreneurship - Gauge Chart -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="entrepreneurshipChart"></canvas>
                        </div>
                    </div>
                    
                        <!-- Chart 6: Family Size Distribution - Polar Area Chart -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="familySizeChart"></canvas>
                        </div>
                            </div>
                        </div>
                    </div>
                    
                <!-- Enhanced Children Data Charts -->
                <div class="enhanced-charts-section">
                    <h3 class="section-subtitle">Children-Related Analytics</h3>
                    <div class="children-charts-grid">
                        <!-- Chart 7: Gender Distribution - Pie Chart -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="genderChart"></canvas>
                </div>
            </div>

                        <!-- Chart 8: Children Age Profile - Polar Area Chart -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="ageProfileChart"></canvas>
                    </div>
                    </div>
                    
                        <!-- Chart 9: Educational Streams - Bar Chart -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="educationalStreamsChart"></canvas>
                </div>
            </div>
            
                        <!-- Chart 10: Medical Needs - Donut Chart -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="medicalNeedsChart"></canvas>
                    </div>
                </div>
            
                        <!-- Chart 11: Health Status Overview - Multi-level Donut -->
                        <div class="enhanced-chart-card">
                            <div class="chart-container">
                                <canvas id="healthOverviewChart"></canvas>
                    </div>
                </div>
                    </div>
                </div>

    </div>
    
            <!-- Families Section - INTEGRATED WITH GOOGLE SHEETS - TO BE FIXED BY JYOTI AND ADAB -->
            <!-- Data is fetched from: Family Details (Ranbankura Eagles) sheet -->
            <!-- Current implementation has issues with CORS proxy reliability and data mapping -->
    <div class="families-section app-section hidden" id="section-families">
        <div class="section-header-row">
                    <h2>Families <span class="count">(274)</span></h2>
            <div class="families-actions">
                <input type="text" class="fam-search" placeholder="Search families..." id="familySearchInput" />
                <select class="workshop-filter" id="workshopFilter">
                    <option value="">All WKSP</option>
                </select>
                <button class="check-btn" onclick="console.log('Refresh button clicked'); fetchFamiliesFromGoogleSheets();" id="refreshFamiliesBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button class="check-btn" onclick="toggleAddFamilyForm()" id="addFamilyBtn">
                    <i class="fas fa-plus"></i> Add Family
                </button>
            </div>
        </div>
        
        <!-- Add Family Modal Popup -->
        <div class="modal-overlay hidden" id="addFamilyModal">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-user-plus"></i>
                        <h3>Add New Family Member</h3>
                    </div>
                    <button class="modal-close-btn" onclick="closeAddFamilyModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <form class="add-family-form" id="addFamilyForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyWksp">WKSP *</label>
                                <input type="text" id="familyWksp" name="wksp" required>
                            </div>
                            <div class="form-group">
                                <label for="familyLadiesName">Ladies Name *</label>
                                <input type="text" id="familyLadiesName" name="ladiesName" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyDateOfBirth">Date of Birth</label>
                                <input type="date" id="familyDateOfBirth" name="dateOfBirth">
                            </div>
                            <div class="form-group">
                                <label for="familyAge">Age</label>
                                <input type="number" id="familyAge" name="age" min="0" max="120">
                            </div>
                            <div class="form-group">
                                <label for="familyBloodGroup">Blood Group</label>
                                <select id="familyBloodGroup" name="bloodGroup">
                                    <option value="">Select Blood Group</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyReligion">Religion</label>
                                <input type="text" id="familyReligion" name="religion">
                            </div>
                            <div class="form-group">
                                <label for="familyQualification">Highest Qualification</label>
                                <input type="text" id="familyQualification" name="qualification">
                            </div>
                            <div class="form-group">
                                <label for="familyLanguages">Languages Known</label>
                                <input type="text" id="familyLanguages" name="languages">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyCanDrive">Can Drive</label>
                                <select id="familyCanDrive" name="canDrive">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="familyOwnsVehicle">Owns Vehicle</label>
                                <select id="familyOwnsVehicle" name="ownsVehicle">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyMobile">Personal Mobile *</label>
                                <input type="tel" id="familyMobile" name="mobile" required>
                            </div>
                            <div class="form-group">
                                <label for="familyEmail">Personal Email</label>
                                <input type="email" id="familyEmail" name="email">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyDateOfMarriage">Date of Marriage</label>
                                <input type="date" id="familyDateOfMarriage" name="dateOfMarriage">
                            </div>
                            <div class="form-group">
                                <label for="familyYearsInMarriage">Years in Marriage</label>
                                <input type="number" id="familyYearsInMarriage" name="yearsInMarriage" min="0" max="100">
                            </div>
                        </div>
                        
                        <!-- Husband's Details -->
                        <div class="form-section-header">
                            <h4>Husband's Details</h4>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyHusbandName">Husband's Name</label>
                                <input type="text" id="familyHusbandName" name="husbandName">
                            </div>
                            <div class="form-group">
                                <label for="familyHusbandRank">Husband's Rank</label>
                                <input type="text" id="familyHusbandRank" name="husbandRank">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyUnit">Unit</label>
                                <input type="text" id="familyUnit" name="unit">
                            </div>
                            <div class="form-group">
                                <label for="familySubUnit">Sub Unit</label>
                                <input type="text" id="familySubUnit" name="subUnit">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyPostingStation">Posting Station</label>
                                <input type="text" id="familyPostingStation" name="postingStation">
                            </div>
                            <div class="form-group">
                                <label for="familyDateOfPosting">Date of Posting</label>
                                <input type="date" id="familyDateOfPosting" name="dateOfPosting">
                            </div>
                        </div>
                        
                        <!-- Accommodation Details -->
                        <div class="form-section-header">
                            <h4>Accommodation Details</h4>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyQuarterNumber">Quarter Number</label>
                                <input type="text" id="familyQuarterNumber" name="quarterNumber">
                            </div>
                            <div class="form-group">
                                <label for="familyColonyName">Colony/Enclave Name</label>
                                <input type="text" id="familyColonyName" name="colonyName">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="familyAccommodationType">Type of Accommodation</label>
                                <input type="text" id="familyAccommodationType" name="accommodationType">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="familyAccommodationAddress">Family Accommodation Address</label>
                                <textarea id="familyAccommodationAddress" name="accommodationAddress" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="closeAddFamilyModal()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-plus"></i> Add Family
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Family Detail Modal -->
        <div class="modal-overlay hidden" id="familyDetailModal">
            <div class="modal-container family-detail-modal">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-user-circle"></i>
                        <h3>Family Details</h3>
                    </div>
                    <button class="modal-close-btn" onclick="closeFamilyDetailModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body family-detail-body">
                    <div class="family-detail-content" id="familyDetailContent">
                        <!-- Family details will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="families-grid" id="familiesGrid"></div>
    </div>

            <!-- Companies Section -->
    <div class="coy-section app-section hidden" id="section-companies">
        <div class="section-header-row">
            <h2>Coy <span class="count">(24)</span></h2>
            <div class="coy-actions">
                <input type="text" class="fam-search" placeholder="Search Coy..." />
                <button class="check-btn">Add Coy</button>
            </div>
        </div>
        <div class="coy-grid" id="coyGrid"></div>
    </div>

            <!-- Newsletter Section -->
    <div class="newsletter-section app-section hidden" id="section-Newsletter">
        <div class="section-header-row">
            <h2>Newsletter</h2>
            <div class="families-actions">
                <a href="#subscribe" class="check-btn">Go to Subscribe</a>
            </div>
        </div>
        <div class="newsletter-grid">
            <div class="newsletter-card">
                <h3>Subscribe to AWWA Updates</h3>
                <p class="subtext">Get monthly highlights, events, and community stories right in your inbox.</p>
                <form id="newsletterForm" class="newsletter-form">
                    <div class="form-row">
                        <label for="nlName">Full name</label>
                        <input type="text" id="nlName" placeholder="Enter your name" required>
                    </div>
                    <div class="form-row">
                        <label for="nlEmail">Email address</label>
                        <input type="email" id="nlEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-row inline">
                        <input type="checkbox" id="nlConsent" required>
                        <label for="nlConsent">I agree to receive newsletters and understand I can unsubscribe anytime.</label>
                    </div>
                    <button type="submit" class="check-btn wide">Subscribe</button>
                    <p id="nlMessage" class="nl-message" aria-live="polite"></p>
                </form>
            </div>

            <div class="newsletter-side">
                <div class="nl-info">
                    <h4>What you'll get</h4>
                    <ul>
                        <li>Monthly digest of AWWA activities</li>
                        <li>Upcoming events & workshops</li>
                        <li>Success stories from our community</li>
                        <li>Volunteer opportunities</li>
                    </ul>
                </div>
                <div class="nl-share">
                    <h4>Share subscription link</h4>
                    <div class="share-row">
                        <input type="text" id="nlShareLink" readonly value="https://awwa.example.com/newsletter/subscribe">
                        <button class="copy-btn" id="copyLinkBtn" type="button"><i class="fas fa-copy"></i></button>
                    </div>
                    <small>Copy this link to invite others to join the newsletter.</small>
                </div>
            </div>
        </div>
    </div>

            <!-- Power BI Section -->
    <div class="powerbi-section app-section hidden" id="section-reports">
        <div class="section-header-row">
            <h2>Analytics (Power BI)</h2>
            <div class="families-actions">
                <a href="https://learn.microsoft.com/power-bi/collaborate-share/service-publish-to-web" target="_blank" class="check-btn">How to get embed link</a>
            </div>
        </div>
        <div class="powerbi-grid">
            <div class="powerbi-config">
                <h3>Embed your report</h3>
                <p class="subtext">Paste a Power BI "Publish to web" URL (starts with https://app.powerbi.com/view?...). We'll remember it for you.</p>
                <div class="form-row">
                    <label for="pbiUrl">Power BI public embed URL</label>
                    <input id="pbiUrl" type="url" placeholder="https://app.powerbi.com/view?r=..." />
                </div>
                <div class="form-row inline">
                    <button id="pbiLoadBtn" class="check-btn">Load report</button>
                    <button id="pbiClearBtn" class="copy-btn" type="button">Clear</button>
                </div>
                <small>Note: For secure embeds (Embed for your organization) you'll need a backend to generate an access token. This UI supports public "Publish to web" links for quick demos.</small>
            </div>
            <div class="powerbi-view">
                <div class="pbi-frame-wrap">
                    <iframe id="pbiFrame" title="Power BI Report" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>

            <!-- Rankings Section -->
    <div class="ranking-section app-section hidden" id="section-Rankings">
        <div class="section-header-row">
            <h2>Unit Rankings</h2>
        </div>
        <div class="ranking-grid">
            <div class="rank-card">
                <div class="rank-left">
                    <div class="rank-badge">1</div>
                    <img src="public/Gemini_Generated_Image_4jitd24jitd24jit.png" alt="Col Tarunpreet Singh" class="rank-avatar-img" />
                </div>
                <div class="rank-info">
                    <div class="rank-title">Rank - Col</div>
                    <h3 class="rank-name">Tarunpreet Singh</h3>
                    <div class="rank-role">Commanding Officer</div>
                    <a href="tel:9650300475" class="rank-phone">Mob No: 9650300475</a>
                </div>
            </div>

            <div class="rank-card">
                <div class="rank-left">
                    <div class="rank-badge">2</div>
                            <img src="public/piyush.jpeg" alt="Lt Col Piyush Sharma" class="rank-avatar-img" />
                </div>
                <div class="rank-info">
                    <div class="rank-title">Rank - Lt Col</div>
                    <h3 class="rank-name">Piyush Sharma</h3>
                    <div class="rank-role">Second in Comd</div>
                    <a href="tel:9797719357" class="rank-phone">Mobile No: 9797719357</a>
                </div>
            </div>

            <div class="rank-card">
                <div class="rank-left">
                    <div class="rank-badge">3</div>
                            <img src="public/harish.jpeg" alt="Maj Harish Kumar" class="rank-avatar-img" />
                </div>
                <div class="rank-info">
                    <div class="rank-title">Rank - Maj</div>
                    <h3 class="rank-name">Harish Kumar</h3>
                    <div class="rank-role">Adjt</div>
                    <a href="tel:9256172418" class="rank-phone">Mob No: 9256172418</a>
                </div>
            </div>

            <div class="rank-card">
                <div class="rank-left">
                    <div class="rank-badge">4</div>
                            <img src="public/Rahul.jpeg" alt="Lt Col Rahul T More" class="rank-avatar-img" />
                </div>
                <div class="rank-info">
                    <div class="rank-title">Rank - Lt Col</div>
                    <h3 class="rank-name">Rahul T More</h3>
                    <div class="rank-role">OIC Tech Cell</div>
                    <a href="tel:7006216984" class="rank-phone">Mobile No: 7006216984</a>
                </div>
            </div>
        </div>
    </div>

        </div>
    </div>

    <script>
        /*
        ===========================================
        GOOGLE SHEETS DATA INTEGRATION - SUPER USER
        ===========================================
        
        This script integrates real family data from Google Sheets for super users:
        https://docs.google.com/spreadsheets/d/1xc4yFUKCHt3_arojTCzc8lf3fGmaco8TzTTJ-HCwpFw/edit?usp=sharing
        
        SUPER USER FEATURES:
        - Enhanced data visualization with additional analytics
        - Advanced filtering and search capabilities
        - Detailed family information display
        - Export functionality for reports
        - Real-time data synchronization
        - Advanced chart interactions
        */
        
        // Google Sheets integration configuration (same as main dashboard)
        const GOOGLE_SHEETS_CONFIG = {
            sheetId: '1xc4yFUKCHt3_arojTCzc8lf3fGmaco8TzTTJ-HCwpFw',
            csvUrl: 'https://docs.google.com/spreadsheets/d/1xc4yFUKCHt3_arojTCzc8lf3fGmaco8TzTTJ-HCwpFw/export?format=csv&gid=0',
            refreshInterval: 300000 // 5 minutes
        };
        
        // Global data storage for super user
        let realFamilyData = [];
        let dataStats = {
            totalFamilies: 0,
            totalChildren: 0,
            registeredFamilies: 0,
            workshopDistribution: {},
            bloodGroupDistribution: {},
            religionDistribution: {},
            ageDistribution: {},
            medicalStatus: {},
            educationLevels: {},
            accommodationTypes: {},
            // Super user specific stats
            specialChildren: 0,
            ivfCases: 0,
            dependents: 0,
            vehicleOwners: 0,
            drivers: 0
        };
        
        /*
        ===========================================
        GOOGLE SHEETS DATA FETCHING - TEAM DISCUSSION REQUIRED
        ===========================================
        
        TODO: Discuss with team before implementing in production
        
        This function fetches data from Google Sheets using multiple methods:
        1. CORS proxy (api.allorigins.win) - bypasses browser CORS restrictions
        2. Direct fetch - may fail due to CORS
        3. Fallback data - sample data if both methods fail
        
        SECURITY CONCERNS FOR TEAM DISCUSSION:
        - Using third-party CORS proxy (api.allorigins.win)
        - Data privacy and security implications
        - Rate limiting and abuse prevention
        - Alternative solutions for production
        
        CURRENT STATUS: Development/Testing Only
        */
        // Function to fetch data from Google Sheets (enhanced for super user)
        async function fetchGoogleSheetsData() {
            console.log('🔄 fetchGoogleSheetsData called - using NEW CORS proxy array');
            try {
                console.log('Fetching data from Google Sheets (Super User)...');
                updateDataStatus('Fetching data...', 'loading');
                
                // Try multiple methods to fetch the data
                let csvText = '';
                
                // Method 1: Try multiple CORS proxies
                let proxyIndex = 0;
                let success = false;
                
                while (proxyIndex < CORS_PROXIES.length && !success) {
                    try {
                        const proxyUrl = CORS_PROXIES[proxyIndex] + encodeURIComponent(GOOGLE_SHEETS_CONFIG.csvUrl);
                        console.log(`Trying CORS proxy ${proxyIndex + 1}:`, CORS_PROXIES[proxyIndex]);
                        
                        const response = await fetch(proxyUrl);
                        
                        if (response.ok) {
                            csvText = await response.text();
                            console.log(`Data fetched via proxy ${proxyIndex + 1} successfully`);
                            success = true;
                        } else {
                            console.log(`Proxy ${proxyIndex + 1} failed:`, response.status);
                            proxyIndex++;
                        }
                    } catch (proxyError) {
                        console.log(`Proxy ${proxyIndex + 1} error:`, proxyError.message);
                        proxyIndex++;
                    }
                }
                
                if (!success) {
                    console.log('All CORS proxies failed, trying direct fetch...');
                    
                    // Method 2: Direct fetch (might fail due to CORS)
                    try {
                        const response = await fetch(GOOGLE_SHEETS_CONFIG.csvUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        csvText = await response.text();
                        console.log('Data fetched directly successfully');
                    } catch (directError) {
                        console.log('Direct fetch failed, using fallback data...', directError);
                        throw new Error('Both proxy and direct fetch failed');
                    }
                }
                
                if (csvText && csvText.trim()) {
                    const parsedData = parseCSVData(csvText);
                    
                    if (parsedData.length > 0) {
                        realFamilyData = parsedData;
                        updateDataStatistics();
                        updateDashboardWithRealData();
                        
                        console.log('Data fetched successfully:', realFamilyData.length, 'families');
                        updateDataStatus(`Last updated: ${new Date().toLocaleTimeString()}`, 'success');
                        return true;
                    } else {
                        throw new Error('No data parsed from CSV');
                    }
                } else {
                    throw new Error('Empty response from server');
                }
                
            } catch (error) {
                console.error('Error fetching Google Sheets data:', error);
                updateDataStatus('Using fallback data', 'error');
                useFallbackData();
                return false;
            }
        }
        
        // Enhanced data statistics for super user
        function updateDataStatistics() {
            dataStats.totalFamilies = realFamilyData.length;
            dataStats.totalChildren = 0;
            dataStats.specialChildren = 0;
            dataStats.ivfCases = 0;
            dataStats.dependents = 0;
            dataStats.vehicleOwners = 0;
            dataStats.drivers = 0;
            dataStats.workshopDistribution = {};
            dataStats.bloodGroupDistribution = {};
            dataStats.religionDistribution = {};
            dataStats.ageDistribution = {};
            dataStats.medicalStatus = { 'No Issues': 0, 'Has Issues': 0, 'Other': 0 };
            dataStats.educationLevels = {};
            dataStats.accommodationTypes = {};
            
            realFamilyData.forEach(family => {
                // Count children and special cases
                if (family['Child 1 Name'] && family['Child 1 Name'].trim()) {
                    dataStats.totalChildren++;
                    if (family['Special Child'] && family['Special Child'].toLowerCase() === 'yes') {
                        dataStats.specialChildren++;
                    }
                }
                if (family['Child 2 Name'] && family['Child 2 Name'].trim()) {
                    dataStats.totalChildren++;
                    if (family['Special Child'] && family['Special Child'].toLowerCase() === 'yes') {
                        dataStats.specialChildren++;
                    }
                }
                if (family['Child 3 Name'] && family['Child 3 Name'].trim()) {
                    dataStats.totalChildren++;
                    if (family['Special Child'] && family['Special Child'].toLowerCase() === 'yes') {
                        dataStats.specialChildren++;
                    }
                }
                
                // Count IVF cases
                if (family['IVF Case'] && family['IVF Case'].toLowerCase() === 'yes') {
                    dataStats.ivfCases++;
                }
                
                // Count dependents
                if (family['Dependent 1 Name'] && family['Dependent 1 Name'].trim()) dataStats.dependents++;
                if (family['Dependent 2 Name'] && family['Dependent 2 Name'].trim()) dataStats.dependents++;
                
                // Count vehicle owners and drivers
                if (family['Owns Vehicle'] && family['Owns Vehicle'].toLowerCase() === 'yes') dataStats.vehicleOwners++;
                if (family['Can Drive'] && family['Can Drive'].toLowerCase() === 'yes') dataStats.drivers++;
                
                // Workshop distribution
                const workshop = family['WKSP'] || 'Unknown';
                dataStats.workshopDistribution[workshop] = (dataStats.workshopDistribution[workshop] || 0) + 1;
                
                // Blood group distribution
                const bloodGroup = family['Blood Group'] || 'Unknown';
                dataStats.bloodGroupDistribution[bloodGroup] = (dataStats.bloodGroupDistribution[bloodGroup] || 0) + 1;
                
                // Religion distribution
                const religion = family['Religion'] || 'Unknown';
                dataStats.religionDistribution[religion] = (dataStats.religionDistribution[religion] || 0) + 1;
                
                // Age distribution
                const age = parseInt(family['Age']) || 0;
                if (age > 0) {
                    const ageGroup = age < 30 ? 'Under 30' : age < 50 ? '30-50' : 'Over 50';
                    dataStats.ageDistribution[ageGroup] = (dataStats.ageDistribution[ageGroup] || 0) + 1;
                }
                
                // Medical status
                const hasMedicalIssues = family['Disease'] && family['Disease'].trim() !== '-' && family['Disease'].trim() !== '';
                if (hasMedicalIssues) {
                    dataStats.medicalStatus['Has Issues']++;
                } else {
                    dataStats.medicalStatus['No Issues']++;
                }
                
                // Education levels
                const education = family['Highest Qualification'] || 'Unknown';
                dataStats.educationLevels[education] = (dataStats.educationLevels[education] || 0) + 1;
                
                // Accommodation types
                const accommodation = family['Type of Accommodation'] || 'Unknown';
                dataStats.accommodationTypes[accommodation] = (dataStats.accommodationTypes[accommodation] || 0) + 1;
            });
            
            dataStats.registeredFamilies = dataStats.totalFamilies;
        }
        
        // Function to update data status indicator
        function updateDataStatus(message, status) {
            const statusElement = document.getElementById('dataStatus');
            const refreshBtn = document.getElementById('refreshDataBtn');
            
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `data-status ${status}`;
            }
            
            if (refreshBtn) {
                if (status === 'loading') {
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                } else {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                }
            }
        }
        
        // CSV parsing functions (same as main dashboard)
        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 3; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length > 0) {
                        const family = {};
                        headers.forEach((header, index) => {
                            family[header] = values[index] || '';
                        });
                        data.push(family);
                    }
                }
            }
            
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // Function to update dashboard with real data
        function updateDashboardWithRealData() {
            // Keep all dashboard values as original static values
            // No dynamic updates to statistics cards or charts
            console.log('Dashboard maintaining original static values');
        }
        
        // Function to update charts with real data
        function updateChartsWithRealData() {
            if (window.__chartsReady) {
                // Keep original chart values - only update statistics cards
                // Charts will maintain their original static values
                console.log('Charts maintaining original values');
            }
        }
        
        // Simple refresh function for dashboard
        function refreshDashboard() {
            console.log('Refreshing dashboard with static values');
            updateDataStatus('Dashboard refreshed', 'success');
            
            // Just refresh the page to show any visual updates
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
        
        // Charts will maintain their original static values as requested
        // No dynamic data updates for chart values
        
        // Chart update functions - keeping original values
        // Charts will maintain their original static values as requested
        
        // Fallback data function
        function useFallbackData() {
            console.log('Using fallback data...');
            
            // Sample data based on your Google Sheets structure
            realFamilyData = [
                {
                    'WKSP': 'BHQ',
                    'Ladies Name': 'Smt Rajni Devi',
                    'Date of Birth': '1998-05-08',
                    'Age': '32',
                    'Blood Group': 'AB+',
                    'Religion': 'Muslim',
                    'Highest Qualification': 'MA Bed',
                    'Can Drive': 'Yes',
                    'Owns Vehicle': 'No',
                    'Personal Mobile': '9465089669',
                    'Husband\'s Name': 'Sub Manjit Singh',
                    'Husband\'s Rank': 'SUB',
                    'Child 1 Name': 'Kirti Thakur',
                    'Child 1 Age': '23',
                    'Child 1 Class': 'BSC 2nd',
                    'Disease': '-',
                    'Type of Accommodation': 'P4/10 Old Umrao',
                    'Special Child': 'No',
                    'IVF Case': 'No',
                    'Dependent 1 Name': '',
                    'Dependent 2 Name': ''
                },
                {
                    'WKSP': '265 FWC',
                    'Ladies Name': 'Smt P Keerthi',
                    'Date of Birth': '1972-03-01',
                    'Age': '58',
                    'Blood Group': 'AB+',
                    'Religion': 'Muslim',
                    'Highest Qualification': 'BSc',
                    'Can Drive': 'Yes',
                    'Owns Vehicle': 'Yes',
                    'Personal Mobile': '7903895195',
                    'Husband\'s Name': 'Hav Praveen Kumar',
                    'Husband\'s Rank': 'HAV',
                    'Child 1 Name': 'Vaishnavi Mehta',
                    'Child 1 Age': '10th',
                    'Child 1 Class': '10th',
                    'Child 2 Name': 'Shaurya Mehta',
                    'Child 2 Age': '6th',
                    'Child 2 Class': '6th',
                    'Disease': '-',
                    'Type of Accommodation': 'P-395/03, Karam Singh Enclave',
                    'Special Child': 'No',
                    'IVF Case': 'No',
                    'Dependent 1 Name': '',
                    'Dependent 2 Name': ''
                },
                {
                    'WKSP': '265 FWC',
                    'Ladies Name': 'Smt Reetika Devi',
                    'Date of Birth': '1996-05-10',
                    'Age': '24',
                    'Blood Group': 'B+',
                    'Religion': 'Sikh',
                    'Highest Qualification': 'MA , BEd',
                    'Can Drive': 'Yes',
                    'Owns Vehicle': 'No',
                    'Personal Mobile': '7668428667',
                    'Husband\'s Name': 'HMT Akash Kumar',
                    'Husband\'s Rank': 'HMT',
                    'Child 1 Name': 'Kush',
                    'Child 1 Age': '-',
                    'Child 1 Class': '-',
                    'Disease': '-',
                    'Type of Accommodation': '15/03, Bana Singh Enclave',
                    'Special Child': 'No',
                    'IVF Case': 'No',
                    'Dependent 1 Name': '',
                    'Dependent 2 Name': ''
                }
            ];
            
            updateDataStatistics();
            updateDashboardWithRealData();
            updateDataStatus('Using sample data', 'error');
        }
        
        // Chart responsiveness and resizing functions
        function makeChartsResponsive() {
            // Add resize event listener for charts
            window.addEventListener('resize', function() {
                Chart.helpers.each(Chart.instances, function(chart) {
                    chart.resize();
                });
            });
            
            // Add chart hover effects
            const chartCards = document.querySelectorAll('.enhanced-chart-card');
            chartCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-4px)';
                    this.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
                });
            });
        }
        
        // Function to update chart sizes based on container
        function updateChartSizes() {
            if (typeof Chart === 'undefined' || !Chart.instances) {
                console.log('Chart.js not available or no instances');
                return;
            }
            
            // Chart.instances is an object, not an array
            const chartInstances = Object.values(Chart.instances);
            chartInstances.forEach(chart => {
                if (chart && chart.canvas && chart.canvas.parentElement) {
                    const container = chart.canvas.parentElement;
                    const containerWidth = container.clientWidth;
                    const containerHeight = container.clientHeight;
                    
                    // Set optimal chart size based on container
                    if (containerWidth < 300) {
                        if (chart.options && chart.options.plugins && chart.options.plugins.legend) {
                            chart.options.plugins.legend.position = 'bottom';
                        }
                        if (chart.options && chart.options.plugins && chart.options.plugins.title) {
                            chart.options.plugins.title.font.size = 14;
                        }
                    } else if (containerWidth < 500) {
                        if (chart.options && chart.options.plugins && chart.options.plugins.legend) {
                            chart.options.plugins.legend.position = 'bottom';
                        }
                        if (chart.options && chart.options.plugins && chart.options.plugins.title) {
                            chart.options.plugins.title.font.size = 16;
                        }
                    } else {
                        if (chart.options && chart.options.plugins && chart.options.plugins.legend) {
                            chart.options.plugins.legend.position = 'right';
                        }
                        if (chart.options && chart.options.plugins && chart.options.plugins.title) {
                            chart.options.plugins.title.font.size = 18;
                        }
                    }
                    
                    chart.update('none');
                }
            });
        }
        
        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Keep all values static - no data fetching
            console.log('Dashboard initialized with static values');
            
            // Initialize chart responsiveness
            setTimeout(makeChartsResponsive, 1000);
            setTimeout(updateChartSizes, 1500);
        });
        
        // Enhanced Charts: initialize on first view of dashboard
async function initChartsOnce() {
  if (window.__chartsReady) return;
  
  // Check if Chart.js is loaded
  if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded');
    return;
  }
  
            // Color palettes for different chart types
            const colorPalettes = {
                medical: ['#10B981', '#F59E0B', '#EF4444'],
                education: ['#8B5CF6', '#EC4899', '#10B981', '#F59E0B', '#3B82F6'],
                gender: ['#3B82F6', '#EC4899', '#6B7280'],
                workshop: ['#8B5CF6', '#EC4899', '#10B981', '#F59E0B', '#3B82F6', '#EF4444', '#84CC16'],
                age: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'],
                health: ['#10B981', '#EF4444']
            };

            // Chart 1: Family Medical Status - Doughnut Chart
            new Chart(document.getElementById('medicalStatusChart'), {
                type: 'doughnut',
    data: {
                    labels: ['No Issues', 'Has Issues', 'Other'],
      datasets: [{
                        data: [239, 30, 2],
                        backgroundColor: colorPalettes.medical,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverOffset: 25,
                        hoverBackgroundColor: ['#059669', '#D97706', '#DC2626']
      }]
    },
    options: {
      responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
      plugins: { 
          title: {
            display: true,
                            text: 'Family Medical Status',
                            font: { size: 16, weight: 'bold' },
                            color: '#1F2937',
                            padding: 20
                        },
                        legend: {
                            position: 'bottom',
                            labels: { 
                                font: { size: 11, weight: '500' },
                                padding: 15,
                                usePointStyle: true,
                                color: '#374151'
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%',
                    animation: { 
                        duration: 1500,
                        easing: 'easeInOutQuart',
                        animateRotate: true
                    }
                }
            });

            // Chart 2: Parental Education - Horizontal Bar Chart
            new Chart(document.getElementById('educationChart'), {
    type: 'bar',
    data: {
                    labels: ['Post Graduate', 'Graduation', '12th Grade', '10th Grade', 'Other'],
      datasets: [{
                        label: 'Number of Families',
                        data: [23, 72, 97, 32, 15],
                        backgroundColor: colorPalettes.education,
                        borderRadius: 8,
                        borderSkipped: false,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverBackgroundColor: colorPalettes.education.map(color => color + 'CC'),
                        hoverBorderWidth: 3
      }]
    },
    options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Parental Education Level',
                            font: { size: 16, weight: 'bold' },
                            color: '#1F2937',
                            padding: 20
                        },
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.x} families`;
                                }
                            }
                        }
                    },
      scales: { 
                        x: { 
                            beginAtZero: true, 
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 },
                                color: '#6B7280'
                            }
                        },
                        y: { 
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 },
                                color: '#6B7280'
                            }
                        }
                    },
                    animation: { 
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            });

            // Chart 3: Marital Discord - Progress Ring
            new Chart(document.getElementById('maritalDiscordChart'), {
                type: 'doughnut',
    data: {
                    labels: ['No Discord', 'Discord Present'],
      datasets: [{
                        data: [250, 24],
                        backgroundColor: ['#10B981', '#EF4444'],
                        borderWidth: 0,
                        hoverOffset: 20
      }]
    },
    options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Marital Discord Status',
                            font: { size: 18, weight: 'bold' },
                            color: '#1F2937'
                        },
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 12 } }
                        }
                    },
                    cutout: '70%',
                    animation: { duration: 2000 }
                }
            });

            // Chart 4: Workshop Distribution - Bar Chart
            new Chart(document.getElementById('workshopChart'), {
    type: 'bar',
    data: {
                    labels: ['288 AW', '832 FWC', '831 FWC', '265 FWC', 'BHQ', '290 FWC', '286 FWC'],
      datasets: [{
                        label: 'Number of Families',
                        data: [65, 60, 38, 36, 30, 23, 22],
                        backgroundColor: colorPalettes.workshop,
                        borderRadius: 8,
                        borderSkipped: false
      }]
    },
    options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
          title: {
            display: true,
                            text: 'Distribution of Family Members',
                            font: { size: 18, weight: 'bold' },
                            color: '#1F2937'
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, grid: { display: false } }
                    },
                    animation: { duration: 2000 }
                }
            });

            // Chart 5: Entrepreneurship - Gauge Chart
            new Chart(document.getElementById('entrepreneurshipChart'), {
    type: 'doughnut',
    data: {
                    labels: ['Not Involved', 'Involved'],
      datasets: [{
                        data: [269, 5],
                        backgroundColor: ['#6B7280', '#10B981'],
                        borderWidth: 0,
                        hoverOffset: 20
      }]
    },
    options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
          title: {
            display: true,
                            text: 'AWWA Entrepreneurship Program',
                            font: { size: 18, weight: 'bold' },
                            color: '#1F2937'
                        },
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 12 } }
                        }
                    },
                    cutout: '80%',
                    animation: { duration: 2000 }
                }
            });

            // Chart 6: Family Size Distribution - Polar Area Chart
            new Chart(document.getElementById('familySizeChart'), {
                type: 'polarArea',
    data: {
                    labels: ['1 Child', '2 Children', '3 Children', '4+ Children'],
      datasets: [{
                        data: [45, 78, 32, 15],
                        backgroundColor: ['#8B5CF6', '#EC4899', '#10B981', '#F59E0B'],
                        borderWidth: 2,
                        borderColor: '#FFFFFF'
      }]
    },
    options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
          title: {
            display: true,
                            text: 'Family Size Distribution',
                            font: { size: 18, weight: 'bold' },
                            color: '#1F2937'
                        },
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 12 } }
                        }
                    },
                    animation: { duration: 2000 }
                }
            });

            // Chart 7: Gender Distribution - Pie Chart
            new Chart(document.getElementById('genderChart'), {
                type: 'pie',
    data: {
                    labels: ['Male', 'Female'],
      datasets: [{
                        data: [33, 14],
                        backgroundColor: ['#3B82F6', '#EC4899'],
                        borderWidth: 3,
                        borderColor: '#FFFFFF',
                        hoverOffset: 20
      }]
    },
    options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
          title: {
            display: true,
                            text: 'Children Gender Distribution',
                            font: { size: 18, weight: 'bold' },
                            color: '#1F2937'
                        },
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 12 } }
                        }
                    },
                    animation: { duration: 2000 }
                }
            });

            // Chart 8: Children Age Profile - Polar Area Chart
            new Chart(document.getElementById('ageProfileChart'), {
                type: 'polarArea',
    data: {
                    labels: ['0-6 years', '6-12 years', '12-18 years', '18-24 years'],
      datasets: [{
                        data: [45, 78, 52, 8],
                        backgroundColor: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'],
                        borderWidth: 2,
                        borderColor: '#FFFFFF'
      }]
    },
    options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
          title: {
            display: true,
                            text: 'Children Age Profile',
                            font: { size: 18, weight: 'bold' },
                            color: '#1F2937'
                        },
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 12 } }
                        }
                    },
                    animation: { duration: 2000 }
                }
            });

            // Chart 9: Educational Streams - Bar Chart
            new Chart(document.getElementById('educationalStreamsChart'), {
    type: 'bar',
    data: {
                    labels: ['Arts', 'Commerce', 'Science', 'PCM', 'PCB', 'Other'],
      datasets: [{
                        label: 'Number of Students',
                        data: [15, 8, 12, 6, 4, 25],
                        backgroundColor: ['#8B5CF6', '#EC4899', '#10B981', '#F59E0B', '#3B82F6', '#EF4444'],
                        borderRadius: 8,
                        borderSkipped: false
      }]
    },
    options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
              title: {
                display: true,
                            text: 'Educational Streams Distribution',
                            font: { size: 18, weight: 'bold' },
                            color: '#1F2937'
                        },
                        legend: { display: false }
                    },
      scales: { 
            x: { 
              grid: { display: false },
                            ticks: { font: { size: 11 } }
                        },
        y: { 
          beginAtZero: true,
                            grid: { display: false },
                            ticks: { stepSize: 5 }
                        }
                    },
                    animation: { duration: 2000 }
                }
            });

            // Chart 10: Medical Needs - Donut Chart
            new Chart(document.getElementById('medicalNeedsChart'), {
    type: 'doughnut',
    data: {
                    labels: ['No Special Needs', 'Special Needs'],
      datasets: [{
                        data: [271, 1],
                        backgroundColor: colorPalettes.health,
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Children Medical Needs',
                            font: { size: 18, weight: 'bold' },
                            color: '#1F2937'
                        },
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 12 } }
                        }
                    },
                    cutout: '60%',
                    animation: { duration: 2000 }
                }
            });

            // Chart 11: Health Status Overview - Multi-level Donut
            new Chart(document.getElementById('healthOverviewChart'), {
                type: 'doughnut',
        data: {
                    labels: ['Healthy Families', 'Families with Medical Issues', 'Children with Special Needs'],
          datasets: [{
                        data: [239, 30, 1],
                        backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                        borderWidth: 0,
                        hoverOffset: 20
          }]
        },
        options: { 
        responsive: true, 
        maintainAspectRatio: false, 
        plugins: { 
              title: {
                display: true,
                            text: 'Overall Health Status',
                            font: { size: 18, weight: 'bold' },
                            color: '#1F2937'
                        },
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 12 } }
                        }
                    },
                    cutout: '50%',
                    animation: { duration: 2000 }
                }
            });

            window.__chartsReady = true;
        }

        // Navigation functionality
        function switchSection(targetSection) {
            // Hide all sections
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show target section
            const target = document.getElementById(targetSection);
            if (target) {
                target.classList.remove('hidden');
            }
            
            // Update navigation active state
            document.querySelectorAll('.lp-nav li').forEach(li => {
                li.classList.remove('active');
            });
            
            const activeNav = document.querySelector(`.lp-nav li[data-target="${targetSection}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }
        }

        // Google Sheets Configuration
        const GOOGLE_SHEET_ID = '1xc4yFUKCHt3_arojTCzc8lf3fGmaco8TzTTJ-HCwpFw';
        const GOOGLE_SHEET_NAME = 'Family Details (Ranbankura Eagles)';
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        
        // IMPORTANT: Replace this with your actual Google Sheets API key
        // To get an API key:
        // 1. Go to Google Cloud Console (https://console.cloud.google.com/)
        // 2. Create a new project or select existing one
        // 3. Enable Google Sheets API
        // 4. Create credentials (API Key)
        // 5. Restrict the key to Google Sheets API and your domain
         const GOOGLE_API_KEY = 'AIzaSyDU-P_oFoohdg6c0yCU3_nWczb3WDiNlPE';
        // CORS ISSUE SOLUTION:
        // If you're getting CORS errors, you have several options:
        // 1. Use a local server (recommended for development):
        //    - Install Python: python -m http.server 8000
        //    - Or use Live Server extension in VS Code
        //    - Access via http://localhost:8000 instead of file://
        // 2. Use a CORS browser extension (for testing only)
        // 3. Deploy to a web server (production solution)
        // 4. Use Google Apps Script as a proxy (see below)
        
        // Simple CORS bypass using JSONP-like approach
        function addFamilyViaJSONP(familyData) {
            return new Promise((resolve, reject) => {
                // Create a form and submit it to a CORS proxy
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://corsproxy.io/?https://sheets.googleapis.com/v4/spreadsheets/' + GOOGLE_SHEET_ID + '/values/' + encodeURIComponent(GOOGLE_SHEET_NAME) + ':append?valueInputOption=USER_ENTERED&key=' + GOOGLE_API_KEY;
                form.target = '_blank';
                
                const dataInput = document.createElement('input');
                dataInput.type = 'hidden';
                dataInput.name = 'data';
                dataInput.value = JSON.stringify({ values: [Object.values(familyData)] });
                form.appendChild(dataInput);
                
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
                
                // Simulate success after a delay
                setTimeout(() => {
                    console.log('Family data submitted via JSONP method');
                    resolve();
                }, 2000);
            });
        }
        
        // Alternative CORS proxies for better reliability
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://thingproxy.freeboard.io/fetch/',
            'https://api.allorigins.win/raw?url=',
            'https://cors-anywhere.herokuapp.com/'
        ];
        
        // Google Apps Script Web App URL (most reliable solution)
        // To set this up:
        // 1. Go to https://script.google.com/
        // 2. Create a new project
        // 3. Copy the code from the comment below
        // 4. Deploy as web app with execute permissions for "Anyone"
        // 5. Replace the URL below with your deployed web app URL
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec';
        
        /*
        GOOGLE APPS SCRIPT CODE (copy this to script.google.com):
        
        function doPost(e) {
          try {
            const data = JSON.parse(e.postData.contents);
            const sheetId = '1xc4yFUKCHt3_arojTCzc8lf3fGmaco8TzTTJ-HCwpFw';
            const sheetName = 'Family Details (Ranbankura Eagles)';
            
            const ss = SpreadsheetApp.openById(sheetId);
            const sheet = ss.getSheetByName(sheetName);
            
            if (data.action === 'addFamily') {
              // Add new family data
              const headers = [
                'WKSP', 'Ladies Name', 'Date of Birth', 'Age', 'Blood Group',
                'Religion', 'Highest Qualification', 'Languages Known', 'Can Drive', 'Owns Vehicle',
                'Personal Mobile', 'Personal Email', 'Date of Marriage', 'Years in Marriage',
                'Husband Details Husbands Name', 'Husband Rank', 'Unit', 'Sub Unit',
                'Posting Station', 'Date of Posting', 'Quarter Number', 'Colony/Enclave Name',
                'Type of Accommodation', 'Family Accommodation Address'
              ];
              
              const rowData = headers.map(header => data.data[header] || '');
              sheet.appendRow(rowData);
              
              return ContentService.createTextOutput(JSON.stringify({
                success: true,
                message: 'Family data added successfully'
              })).setMimeType(ContentService.MimeType.JSON);
            }
            
            return ContentService.createTextOutput(JSON.stringify({
              success: false,
              message: 'Invalid action'
            })).setMimeType(ContentService.MimeType.JSON);
            
          } catch (error) {
            return ContentService.createTextOutput(JSON.stringify({
              success: false,
              message: error.toString()
            })).setMimeType(ContentService.MimeType.JSON);
          }
        }
        
        function doGet(e) {
          try {
            const sheetId = '1xc4yFUKCHt3_arojTCzc8lf3fGmaco8TzTTJ-HCwpFw';
            const sheetName = 'Family Details (Ranbankura Eagles)';
            
            const ss = SpreadsheetApp.openById(sheetId);
            const sheet = ss.getSheetByName(sheetName);
            const data = sheet.getDataRange().getValues();
            
            return ContentService.createTextOutput(JSON.stringify({
              success: true,
              data: data
            })).setMimeType(ContentService.MimeType.JSON);
            
          } catch (error) {
            return ContentService.createTextOutput(JSON.stringify({
              success: false,
              message: error.toString()
            })).setMimeType(ContentService.MimeType.JSON);
          }
        }
        */
        
        // Families data from Google Sheets
        let familiesData = [];
        let filteredFamiliesData = [];
        let isLoadingFamilies = false;
        let availableWorkshops = [];

        // Fetch families data from Google Sheets - TO BE FIXED BY JYOTI AND ADAB
        // Current implementation has issues with CORS proxy reliability and data mapping
        async function fetchFamiliesFromGoogleSheets() {
            if (isLoadingFamilies) {
                console.log('Already loading families, skipping...');
                return;
            }
            
            console.log('Starting to fetch families data...');
            isLoadingFamilies = true;
            updateFamiliesStatus('loading');
            
            try {
                // Construct the Google Sheets CSV export URL
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(GOOGLE_SHEET_NAME)}`;
                console.log('Fetching from:', sheetUrl);
                console.log('Available CORS proxies:', CORS_PROXIES);
                
                let response;
                let csvText;
                
                // Try multiple CORS proxies
                const proxies = CORS_PROXIES;
                
                let proxyIndex = 0;
                let success = false;
                
                while (proxyIndex < proxies.length && !success) {
                    try {
                        const proxyUrl = proxies[proxyIndex] + encodeURIComponent(sheetUrl);
                        console.log(`Trying proxy ${proxyIndex + 1}:`, proxyUrl);
                        
                        response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/csv,text/plain,*/*',
                            }
                        });
                        
                        if (response.ok) {
                            csvText = await response.text();
                            console.log(`Proxy ${proxyIndex + 1} successful, got`, csvText.length, 'characters');
                            success = true;
                        } else {
                            console.log(`Proxy ${proxyIndex + 1} failed:`, response.status);
                            proxyIndex++;
                        }
                    } catch (proxyError) {
                        console.log(`Proxy ${proxyIndex + 1} error:`, proxyError.message);
                        proxyIndex++;
                    }
                }
                
                if (!success) {
                    throw new Error('All CORS proxies failed. Please check your internet connection or try again later.');
                }
                
                // Parse the CSV data
                const families = parseFamiliesCSV(csvText);
                console.log('Parsed families:', families.length);
                
                if (families.length === 0) {
                    throw new Error('No families found in the data');
                }
                
                familiesData = families;
                filteredFamiliesData = [...families]; // Initialize filtered data
                populateWorkshopFilter();
                updateFamiliesStatus('success');
                loadFamilies(); // Refresh the display
                
                // Show success message
                console.log('Successfully loaded', families.length, 'families from Google Sheets');
                
            } catch (error) {
                console.error('Error fetching families data:', error);
                updateFamiliesStatus('error');
                
                // Fallback to sample data
                familiesData = getSampleFamiliesData();
                filteredFamiliesData = [...familiesData];
                populateWorkshopFilter();
                loadFamilies();
                
                // Show error message to user
                alert(`Failed to load data from Google Sheets: ${error.message}\n\nUsing sample data instead.`);
            } finally {
                isLoadingFamilies = false;
                console.log('Finished loading families data');
            }
        }

        // Parse CSV data for families - TO BE FIXED BY JYOTI AND ADAB
        // Current implementation has issues with column mapping and data parsing
        function parseFamiliesCSV(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    console.warn('CSV has less than 2 lines');
                    return [];
                }
                
                // Parse CSV with proper handling of quoted fields
                function parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result;
                }
                
                const headers = parseCSVLine(lines[0]);
                console.log('CSV Headers:', headers);
                console.log('Total lines:', lines.length);
                
                // Log all column names that might contain husband information
                const husbandColumns = headers.filter(h => 
                    h.toLowerCase().includes('husband') || 
                    h.toLowerCase().includes('spouse')
                );
                console.log('Husband-related columns:', husbandColumns);
                console.log()
                
                // Log all headers to see the exact format
                console.log('All headers:', headers.map((h, i) => `${i}: "${h}"`));
                
                const families = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = parseCSVLine(line);
                    
                    // Skip if we don't have enough values or if it's a header row
                    if (values.length < headers.length || values[0] === 'WKSP') {
                        continue;
                    }
                    
                    const family = {};
                    headers.forEach((header, index) => {
                        family[header.toLowerCase().replace(/\s+/g, '_')] = values[index] || '';
                    });
                    
                    // Map to our expected format using exact column names from the sheet
                    const ladyName = family.personal_information_ladies_name || '';
                    // Use the exact column name from the CSV headers
                    const husbandName = family.husband_details_husbands_name || '';
                    const mobile = family.personal_mobile || '';
                    const qualification = family.highest_qualification || '';
                    const bloodGroup = family.blood_group || '';
                    const religion = family.religion || '';
                    const marriageDate = family.date_of_marriage || '';
                    const yearsInMarriage = family.years_in_marriage || '';
                    const email = family.personal_email || '';
                    const languages = family.languages_known || '';
                    const canDrive = family.can_drive || '';
                    const ownsVehicle = family.owns_vehicle || '';
                    const husbandRank = family.husbands_rank || '';
                    const unit = family.unit || '';
                    const subUnit = family.sub_unit || '';
                    const postingStation = family.posting_station || '';
                    const dateOfPosting = family.date_of_posting || '';
                    const quarterNumber = family.quarter_number || '';
                    const colonyName = family.colony_enclave_name || '';
                    const accommodationType = family.type_of_accommodation || '';
                    const accommodationAddress = family.family_accommodation_address || '';
                    
                    // Extract workshop information from WKSP column
                    const workshop = family.wksp || '';
                    
                    // Debug logging for husband name
                    if (ladyName && ladyName.trim()) {
                        console.log('Family:', ladyName, 'Husband data:', {
                            husbands_details_husbands_name: family.husbands_details_husbands_name,
                            husbands_name: family.husbands_name,
                            husband_name: family.husband_name,
                            husband: family.husband,
                            final: husbandName
                        });
                    }
                    
                    // Only add if we have at least a lady's name
                    if (ladyName && ladyName.trim()) {
                        const familyData = {
                            id: families.length + 1,
                            name: ladyName.trim(),
                            husband: husbandName.trim() || 'N/A',
                            contact: mobile.trim() || 'N/A',
                            education: qualification.trim() || 'N/A',
                            children: yearsInMarriage.trim() || 'N/A',
                            joined: marriageDate.trim() || 'N/A',
                            workshop: workshop.trim() || 'N/A',
                            // Additional fields from the sheet
                            email: email.trim() || 'N/A',
                            bloodGroup: bloodGroup.trim() || 'N/A',
                            religion: religion.trim() || 'N/A',
                            languages: languages.trim() || 'N/A',
                            canDrive: canDrive.trim() || 'N/A',
                            ownsVehicle: ownsVehicle.trim() || 'N/A',
                            husbandRank: husbandRank.trim() || 'N/A',
                            unit: unit.trim() || 'N/A',
                            subUnit: subUnit.trim() || 'N/A',
                            postingStation: postingStation.trim() || 'N/A',
                            dateOfPosting: dateOfPosting.trim() || 'N/A',
                            quarterNumber: quarterNumber.trim() || 'N/A',
                            colonyName: colonyName.trim() || 'N/A',
                            accommodationType: accommodationType.trim() || 'N/A',
                            accommodationAddress: accommodationAddress.trim() || 'N/A'
                        };
                        
                        families.push(familyData);
                        
                        // Collect unique workshops for filter
                        if (workshop && workshop.trim() && workshop.trim() !== 'N/A') {
                            if (!availableWorkshops.includes(workshop.trim())) {
                                availableWorkshops.push(workshop.trim());
                            }
                        }
                    }
                }
                
                console.log(`Parsed ${families.length} families from CSV`);
                return families;
                
            } catch (error) {
                console.error('Error parsing CSV:', error);
                return [];
            }
        }

        // Sample data fallback
        function getSampleFamiliesData() {
            return Array.from({ length: 10 }, (_, i) => {
                const surnames = ['Sharma', 'Singh', 'Kumar', 'Gupta', 'Verma', 'Patel', 'Reddy', 'Joshi', 'Agarwal', 'Jain'];
                const firstNames = ['Rajesh', 'Vikram', 'Amit', 'Suresh', 'Ravi', 'Raj', 'Kiran', 'Sunil', 'Pradeep', 'Anil'];
                const educations = ['B.Tech', 'MBA', 'B.Sc', 'M.A', 'B.Com', 'M.Tech', 'B.A', 'M.Sc', 'B.E', 'M.Com'];
            const childrenCounts = ['1 Child', '2 Children', '3 Children', '1 Child', '2 Children', '1 Child', '2 Children', '3 Children', '1 Child', '2 Children'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'];
            
            return {
                id: i + 1,
                name: `${surnames[i % surnames.length]} Family`,
                husband: `${firstNames[i % firstNames.length]} ${surnames[i % surnames.length]}`,
                contact: `+91-${9876500000 + i}`,
                education: educations[i % educations.length],
                children: childrenCounts[i % childrenCounts.length],
                joined: `${months[i % months.length]} 2024`
            };
        });
        }

        // Update families status indicator
        function updateFamiliesStatus(status) {
            const countElement = document.querySelector('#section-families .count');
            const refreshBtn = document.getElementById('refreshFamiliesBtn');
            
            if (countElement) {
                switch (status) {
                    case 'loading':
                        countElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                        break;
                    case 'success':
                        countElement.textContent = `(${familiesData.length})`;
                        break;
                    case 'error':
                        countElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                        break;
                    default:
                        countElement.textContent = `(${familiesData.length})`;
                }
            }
            
            if (refreshBtn) {
                const icon = refreshBtn.querySelector('i');
                const text = refreshBtn.querySelector('span') || refreshBtn.childNodes[refreshBtn.childNodes.length - 1];
                
                switch (status) {
                    case 'loading':
                        icon.className = 'fas fa-spinner fa-spin';
                        refreshBtn.disabled = true;
                        refreshBtn.style.opacity = '0.6';
                        refreshBtn.title = 'Loading data...';
                        break;
                    case 'success':
                        icon.className = 'fas fa-sync-alt';
                        refreshBtn.disabled = false;
                        refreshBtn.style.opacity = '1';
                        refreshBtn.title = 'Refresh data from Google Sheets';
                        break;
                    case 'error':
                        icon.className = 'fas fa-sync-alt';
                        refreshBtn.disabled = false;
                        refreshBtn.style.opacity = '1';
                        refreshBtn.title = 'Retry loading data';
                        break;
                }
            }
        }

        // Sample companies data (matching old dashboard style)
        const companiesData = [
            { id: "Coy001", femaleName: "Priya Sharma", spouseName: "Rajesh Sharma", education: "B.Tech", phoneNumber: "+91-9000000001", rank: "Col" },
            { id: "Coy002", femaleName: "Kavita Singh", spouseName: "Vikram Singh", education: "MBA", phoneNumber: "+91-9000000002", rank: "Lt Col" },
            { id: "Coy003", femaleName: "Sunita Verma", spouseName: "Amit Verma", education: "B.Sc", phoneNumber: "+91-9000000003", rank: "Maj" },
            { id: "Coy004", femaleName: "Rekha Patel", spouseName: "Ravi Patel", education: "M.A", phoneNumber: "+91-9000000004", rank: "Capt" },
            { id: "Coy005", femaleName: "Meera Gupta", spouseName: "Suresh Gupta", education: "B.Com", phoneNumber: "+91-9000000005", rank: "Lt" },
            { id: "Coy006", femaleName: "Anita Kumar", spouseName: "Raj Kumar", education: "M.Tech", phoneNumber: "+91-9000000006", rank: "Sqn Ldr" },
            { id: "Coy007", femaleName: "Sushila Yadav", spouseName: "Vijay Yadav", education: "B.A", phoneNumber: "+91-9000000007", rank: "Flt Lt" },
            { id: "Coy008", femaleName: "Geeta Tiwari", spouseName: "Ramesh Tiwari", education: "M.Sc", phoneNumber: "+91-9000000008", rank: "Fg Offr" }
        ];

        // Populate WKSP filter dropdown
        function populateWorkshopFilter() {
            const workshopFilter = document.getElementById('workshopFilter');
            if (!workshopFilter) return;
            
            // Clear existing options except "All WKSP"
            workshopFilter.innerHTML = '<option value="">All WKSP</option>';
            
            // Sort WKSP alphabetically
            const sortedWorkshops = availableWorkshops.sort();
            
            // Add WKSP options
            sortedWorkshops.forEach(workshop => {
                const option = document.createElement('option');
                option.value = workshop;
                option.textContent = workshop;
                workshopFilter.appendChild(option);
            });
            
            console.log('Available WKSP:', sortedWorkshops);
        }

        // Filter families based on search and WKSP
        function filterFamilies() {
            const searchTerm = document.getElementById('familySearchInput')?.value.toLowerCase() || '';
            const workshopFilter = document.getElementById('workshopFilter')?.value || '';
            
            filteredFamiliesData = familiesData.filter(family => {
                const matchesSearch = !searchTerm || 
                    family.name.toLowerCase().includes(searchTerm) ||
                    family.husband.toLowerCase().includes(searchTerm) ||
                    family.contact.toLowerCase().includes(searchTerm) ||
                    family.education.toLowerCase().includes(searchTerm);
                
                const matchesWKSP = !workshopFilter || 
                    family.workshop === workshopFilter;
                
                return matchesSearch && matchesWKSP;
            });
            
            loadFamilies();
            updateFamiliesCount();
        }

        // Update families count display
        function updateFamiliesCount() {
            const countElement = document.querySelector('#section-families .count');
            if (countElement) {
                countElement.textContent = `(${filteredFamiliesData.length})`;
            }
        }

        // ===========================================
        // FAMILY FORM MANAGEMENT FUNCTIONS
        // ===========================================
        
        // Open Add Family Modal
        function toggleAddFamilyForm() {
            // Check if user has permission to add families (Super Users only)
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            const isSuperUser = userInfo.userType === 'L1' || userInfo.userType === 'admin';
            
            if (!isSuperUser) {
                alert('Only Super Users can add family data. Please contact your administrator.');
                return;
            }
            
            const modal = document.getElementById('addFamilyModal');
            console.log('Modal element:', modal); // Debug log
            
            if (modal) {
                console.log('Opening modal...'); // Debug log
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                console.log('Modal classes after opening:', modal.className); // Debug log
                console.log('Modal computed style display:', window.getComputedStyle(modal).display); // Debug log
            } else {
                console.error('Modal element not found!');
            }
        }
        
        // Close Add Family Modal
        function closeAddFamilyModal() {
            const modal = document.getElementById('addFamilyModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
                resetAddFamilyForm();
                console.log('Modal closed'); // Debug log
            }
        }
        
        // Reset Add Family Form
        function resetAddFamilyForm() {
            const form = document.getElementById('addFamilyForm');
            if (form) {
                form.reset();
            }
        }
        
        // Handle Add Family Form Submission
        function handleAddFamilyForm(event) {
            event.preventDefault();
            
            // Get form data
            const formData = new FormData(event.target);
            const familyData = {};
            
            // Convert FormData to object
            for (let [key, value] of formData.entries()) {
                familyData[key] = value;
            }
            
            // Validate required fields
            if (!familyData.wksp || !familyData.ladiesName || !familyData.mobile) {
                alert('Please fill in all required fields (WKSP, Ladies Name, and Personal Mobile)');
                return;
            }
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            submitBtn.disabled = true;
            
            // Add family to Google Sheets
            addFamilyToGoogleSheets(familyData)
                .then(() => {
                    alert('Family added successfully to Google Sheets!');
                    resetAddFamilyForm();
                    closeAddFamilyModal();
                    // Refresh families data
                    fetchFamiliesFromGoogleSheets();
                })
                .catch((error) => {
                    console.error('Error adding family:', error);
                    if (error.message.includes('API key not configured')) {
                        alert('Google Sheets API not configured. Family data has been saved locally. Please contact the administrator to configure the API.');
                    } else {
                        const errorMessage = handleCORSError(error, 'adding family to Google Sheets');
                        alert('Error adding family: ' + errorMessage);
                    }
                })
                .finally(() => {
                    // Reset button state
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        }
        
        // Check Add Family Permissions
        function checkAddFamilyPermissions() {
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            const isSuperUser = userInfo.userType === 'L1' || userInfo.userType === 'admin';
            const addFamilyBtn = document.getElementById('addFamilyBtn');
            
            if (addFamilyBtn) {
                if (isSuperUser) {
                    // Show Add Family button for super users
                    addFamilyBtn.style.display = 'flex';
                } else {
                    // Hide Add Family button for non-super users
                    addFamilyBtn.style.display = 'none';
                }
            }
        }

        // Check if Google Sheets API is properly configured
        function isGoogleSheetsConfigured() {
            return GOOGLE_API_KEY && GOOGLE_API_KEY !== 'YOUR_GOOGLE_SHEETS_API_KEY_HERE';
        }

        // Display pending families from localStorage
        function displayPendingFamilies() {
            const pendingFamilies = JSON.parse(localStorage.getItem('pendingFamilies') || '[]');
            if (pendingFamilies.length > 0) {
                console.log('Pending families in localStorage:', pendingFamilies);
                // You can add UI to display these pending families
                // For now, we'll just log them
            }
        }

        // Handle CORS issues with better error messages
        function handleCORSError(error, context = 'API call') {
            console.error(`CORS Error in ${context}:`, error);
            
            if (error.message.includes('CORS')) {
                return 'CORS policy blocked the request. This is a browser security feature. Please try using a different browser or contact the administrator.';
            } else if (error.message.includes('NetworkError')) {
                return 'Network error occurred. Please check your internet connection and try again.';
            } else if (error.message.includes('Failed to fetch')) {
                return 'Failed to connect to the server. Please check your internet connection and try again.';
            } else {
                return `Error: ${error.message}`;
            }
        }

        // Add Family to Google Sheets
        async function addFamilyToGoogleSheets(familyData) {
            try {
                console.log('Adding family to Google Sheets:', familyData);
                console.log('API Key configured:', isGoogleSheetsConfigured());
                console.log('API Key value:', GOOGLE_API_KEY);
                
                // Check if API key is configured
                if (!isGoogleSheetsConfigured()) {
                    throw new Error('Google Sheets API key not configured. Please contact administrator.');
                }
                
                // Map form data to Google Sheets column structure (matching actual Excel sheet)
                const mappedData = {
                    'WKSP': familyData.wksp || '',
                    'Ladies Name': familyData.ladiesName || '',
                    'Date of Birth': familyData.dateOfBirth || '',
                    'Age': familyData.age || '',
                    'Blood Group': familyData.bloodGroup || '',
                    'Religion': familyData.religion || '',
                    'Highest Qualification': familyData.qualification || '',
                    'Languages Known': familyData.languages || '',
                    'Can Drive': familyData.canDrive || '',
                    'Owns Vehicle': familyData.ownsVehicle || '',
                    'Personal Mobile': familyData.mobile || '',
                    'Personal Email': familyData.email || '',
                    'Date of Marriage': familyData.dateOfMarriage || '',
                    'Years in Marriage': familyData.yearsInMarriage || '',
                    'Husband Details Husbands Name': familyData.husbandName || '',
                    'Husband Rank': familyData.husbandRank || '',
                    'Unit': familyData.unit || '',
                    'Sub Unit': familyData.subUnit || '',
                    'Posting Station': familyData.postingStation || '',
                    'Date of Posting': familyData.dateOfPosting || '',
                    'Quarter Number': familyData.quarterNumber || '',
                    'Colony/Enclave Name': familyData.colonyName || '',
                    'Type of Accommodation': familyData.accommodationType || '',
                    'Family Accommodation Address': familyData.accommodationAddress || ''
                };
                
                // Get the headers from the existing data to maintain column order
                const headers = [
                    'WKSP', 'Ladies Name', 'Date of Birth', 'Age', 'Blood Group',
                    'Religion', 'Highest Qualification', 'Languages Known', 'Can Drive', 'Owns Vehicle',
                    'Personal Mobile', 'Personal Email', 'Date of Marriage', 'Years in Marriage',
                    'Husband Details Husbands Name', 'Husband Rank', 'Unit', 'Sub Unit',
                    'Posting Station', 'Date of Posting', 'Quarter Number', 'Colony/Enclave Name',
                    'Type of Accommodation', 'Family Accommodation Address'
                ];
                
                // Create the row data in the correct order
                const rowData = headers.map(header => mappedData[header] || '');
                
                // Method 1: Try Google Apps Script (most reliable)
                if (GOOGLE_APPS_SCRIPT_URL && GOOGLE_APPS_SCRIPT_URL !== 'https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec') {
                    try {
                        console.log('Trying Google Apps Script method...');
                        
                        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'addFamily',
                                data: mappedData
                            })
                        });
                        
                        console.log('Family data submitted via Google Apps Script');
                        
                        // Refresh the families data to show the new entry
                        await fetchFamiliesFromGoogleSheets();
                        
                        return Promise.resolve();
                    } catch (scriptError) {
                        console.log('Google Apps Script method failed, trying CORS proxies...', scriptError);
                    }
                } else {
                    console.log('Google Apps Script not configured, trying CORS proxies...');
                }
                
                // Method 2: Try multiple CORS proxies (fallback)
                let proxyIndex = 0;
                let success = false;
                
                while (proxyIndex < CORS_PROXIES.length && !success) {
                    try {
                        const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${encodeURIComponent(GOOGLE_SHEET_NAME)}:append?valueInputOption=USER_ENTERED&key=${GOOGLE_API_KEY}`;
                        const proxyUrl = CORS_PROXIES[proxyIndex] + encodeURIComponent(apiUrl);
                        
                        console.log(`Trying CORS proxy ${proxyIndex + 1}:`, CORS_PROXIES[proxyIndex]);
                        
                        const response = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                values: [rowData]
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log(`Family data successfully added via proxy ${proxyIndex + 1}:`, result);
                            
                            // Refresh the families data to show the new entry
                            await fetchFamiliesFromGoogleSheets();
                            
                            success = true;
                            return result;
                        } else {
                            console.log(`Proxy ${proxyIndex + 1} failed:`, response.status, response.statusText);
                            proxyIndex++;
                        }
                    } catch (proxyError) {
                        console.log(`Proxy ${proxyIndex + 1} error:`, proxyError.message);
                        proxyIndex++;
                    }
                }
                
                if (!success) {
                    console.log('All methods failed, using fallback...');
                    throw new Error('All API methods failed. Please set up Google Apps Script or use a local server.');
                }
                
            } catch (error) {
                console.error('Error adding family to Google Sheets:', error);
                
                // Fallback: Store in localStorage and show instructions
                try {
                    const pendingFamilies = JSON.parse(localStorage.getItem('pendingFamilies') || '[]');
                    pendingFamilies.push({
                        ...familyData,
                        timestamp: new Date().toISOString(),
                        id: Date.now()
                    });
                    localStorage.setItem('pendingFamilies', JSON.stringify(pendingFamilies));
                    
                    // Show instructions to user
                    alert(`Family data saved locally due to CORS error. To fix this:\n\n1. Run a local server:\n   python -m http.server 8000\n\n2. Open: http://localhost:8000/dashboard_super user.html\n\n3. Try adding the family again\n\nFamily: ${familyData.ladiesName}\nWKSP: ${familyData.wksp}\nMobile: ${familyData.mobile}\n\nError: ${error.message}`);
                    
                    console.log('Family data stored locally as fallback');
                    return Promise.resolve();
                } catch (fallbackError) {
                    console.error('Fallback method also failed:', fallbackError);
                    throw new Error(`Failed to add family data: ${error.message}`);
                }
            }
        }

        // ===========================================
        // FAMILY DETAIL MODAL FUNCTIONS
        // ===========================================
        
        // Open Family Detail Modal
        function openFamilyDetailModal(familyData) {
            console.log('Opening family detail modal for:', familyData);
            const modal = document.getElementById('familyDetailModal');
            if (modal) {
                populateFamilyDetailContent(familyData);
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
        }
        
        // Close Family Detail Modal
        function closeFamilyDetailModal() {
            const modal = document.getElementById('familyDetailModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }
        
        // Populate Family Detail Content
        function populateFamilyDetailContent(family) {
            const content = document.getElementById('familyDetailContent');
            if (!content) return;
            
            // Create the detailed family information HTML
            content.innerHTML = `
                <div class="family-detail-section">
                    <h4><i class="fas fa-user"></i> Personal Information</h4>
                    <div class="family-photo">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Name</span>
                        <span class="detail-value highlight">${family.name || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">WKSP</span>
                        <span class="detail-value">${family.wksp || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date of Birth</span>
                        <span class="detail-value">${family.joined || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Blood Group</span>
                        <span class="detail-value">${family.bloodGroup || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Religion</span>
                        <span class="detail-value">${family.religion || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Education</span>
                        <span class="detail-value">${family.education || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Languages</span>
                        <span class="detail-value">${family.languages || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Can Drive</span>
                        <span class="detail-value">${family.canDrive || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Owns Vehicle</span>
                        <span class="detail-value">${family.ownsVehicle || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="family-detail-section">
                    <h4><i class="fas fa-heart"></i> Family Details</h4>
                    <div class="detail-row">
                        <span class="detail-label">Husband Name</span>
                        <span class="detail-value highlight">${family.husband || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Husband Rank</span>
                        <span class="detail-value">${family.husbandRank || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Unit</span>
                        <span class="detail-value">${family.unit || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Sub Unit</span>
                        <span class="detail-value">${family.subUnit || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Posting Station</span>
                        <span class="detail-value">${family.postingStation || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date of Posting</span>
                        <span class="detail-value">${family.dateOfPosting || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Children</span>
                        <span class="detail-value">${family.children || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="family-detail-section">
                    <h4><i class="fas fa-home"></i> Accommodation</h4>
                    <div class="detail-row">
                        <span class="detail-label">Quarter Number</span>
                        <span class="detail-value">${family.quarterNumber || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Colony Name</span>
                        <span class="detail-value">${family.colonyName || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Accommodation Type</span>
                        <span class="detail-value">${family.accommodationType || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Address</span>
                        <span class="detail-value">${family.accommodationAddress || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="family-detail-section">
                    <h4><i class="fas fa-phone"></i> Contact Information</h4>
                    <div class="contact-info">
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <span>${family.contact || 'N/A'}</span>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-envelope"></i>
                            <span>${family.email || 'N/A'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="family-detail-section">
                    <h4><i class="fas fa-chart-bar"></i> Family Statistics</h4>
                    <div class="family-stats">
                        <div class="stat-card">
                            <div class="stat-number">${family.wksp || 'N/A'}</div>
                            <div class="stat-label">Workshop</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${family.education ? family.education.split(' ').length : '0'}</div>
                            <div class="stat-label">Education Level</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${family.canDrive === 'Yes' ? '1' : '0'}</div>
                            <div class="stat-label">Can Drive</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Add event listeners for family detail modal
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal when clicking outside
            document.addEventListener('click', function(event) {
                const modal = document.getElementById('familyDetailModal');
                if (modal && !modal.classList.contains('hidden')) {
                    if (event.target === modal) {
                        closeFamilyDetailModal();
                    }
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeFamilyDetailModal();
                }
            });
        });

        // Load families data from Google Sheets
        function loadFamilies() {
            const familiesGrid = document.getElementById('familiesGrid');
            if (!familiesGrid) return;

            if (filteredFamiliesData.length === 0) {
                familiesGrid.innerHTML = `
                    <div class="no-data-message">
                        <i class="fas fa-info-circle"></i>
                        <p>No families found matching your filters. Try adjusting your search or WKSP filter.</p>
                    </div>
                `;
                return;
            }

            familiesGrid.innerHTML = filteredFamiliesData.map(f => `
                <div class="family-card" onclick="openFamilyDetailModal(${JSON.stringify(f).replace(/"/g, '&quot;')})" style="cursor: pointer;">
                    <div class="fc-top">
                        <h4>${f.name}</h4>
                        <span class="badge success">AWWA REGISTERED</span>
                    </div>
                    <div class="fc-body">
                        <div class="row"><span class="label">Husband Name:</span><span class="val">${f.husband}</span></div>
                        <div class="row"><span class="label">Contact:</span><span class="val">${f.contact}</span></div>
                        <div class="row"><span class="label">Education:</span><span class="val">${f.education}</span></div>
                        <div class="row"><span class="label">WKSP:</span><span class="val">${f.workshop}</span></div>
                    </div>
                </div>
            `).join('');
        }

        // Load companies data (matching old dashboard style)
        function loadCompanies() {
            const coyGrid = document.getElementById('coyGrid');
            if (!coyGrid) return;

            coyGrid.innerHTML = companiesData.map(c => `
                <div class="family-card">
                    <div class="fc-top">
                        <h4>${c.id}</h4>
                        <span class="badge success">${c.rank}</span>
                    </div>
                    <div class="fc-body">
                        <div class="row"><span class="label">Female Name:</span><span class="val">${c.femaleName}</span></div>
                        <div class="row"><span class="label">Spouse Name:</span><span class="val">${c.spouseName}</span></div>
                        <div class="row"><span class="label">Education:</span><span class="val">${c.education}</span></div>
                        <div class="row"><span class="label">Phone:</span><span class="val">${c.phoneNumber}</span></div>
                    </div>
                </div>
            `).join('');
        }

        // Initialize navigation
document.addEventListener('DOMContentLoaded', function() {
            // Add click listeners to navigation
            document.querySelectorAll('.lp-nav li').forEach(li => {
                li.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    switchSection(target);
                    
                    // Load data based on section
                    if (target === 'section-families') {
                        // Fetch fresh data from Google Sheets when families section is opened
                        if (familiesData.length === 0) {
                            fetchFamiliesFromGoogleSheets();
                        } else {
                        loadFamilies();
                        }
                    } else if (target === 'section-companies') {
                        loadCompanies();
                    }
                    
                    // Initialize charts when dashboard is shown
                    if (target === 'section-dashboard') {
  setTimeout(initChartsOnce, 500);
                    }
                    
                    // Close navigation on mobile after clicking
                    if (window.innerWidth <= 768) {
                        const lpNav = document.getElementById('lpNav');
                        const navToggle = document.getElementById('navToggle');
                        const icon = navToggle.querySelector('i');
                        const text = navToggle.querySelector('span');
                        
                        lpNav.classList.remove('expanded');
                        lpNav.classList.add('collapsed');
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                        text.textContent = 'Menu';
                        navToggle.classList.remove('active');
                    }
                });
            });
            
            // Add event listeners for family filtering
            const familySearchInput = document.getElementById('familySearchInput');
            const workshopFilter = document.getElementById('workshopFilter');
            
            if (familySearchInput) {
                familySearchInput.addEventListener('input', filterFamilies);
            }
            
            if (workshopFilter) {
                workshopFilter.addEventListener('change', filterFamilies);
            }
            
            // Initialize charts
            setTimeout(initChartsOnce, 1000);
            
            // Add form event listener for Add Family form
            const addFamilyForm = document.getElementById('addFamilyForm');
            if (addFamilyForm) {
                addFamilyForm.addEventListener('submit', handleAddFamilyForm);
            }
            
            // Check user permissions for Add Family button
            checkAddFamilyPermissions();
            
            // Add modal close functionality
            const modal = document.getElementById('addFamilyModal');
            if (modal) {
                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeAddFamilyModal();
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                        closeAddFamilyModal();
                    }
                });
            }
        });

        
        function loadUserInfo() {
            // ===========================================
            // DEFAULT USER DATA (FALLBACK)
            // ===========================================
            // This serves as a fallback if no user data is found in localStorage.
            // Used for demonstration purposes or when accessing dashboard directly.
            
            const defaultUserInfo = {
                userId: 'tarunpreet singh',
                name: 'Col Tarunpreet Singh',
                designation: 'Commanding Officer',
                phone: '9650300475',
                userType: 'L1',
                hasSpouse: true,  // Default user has spouse information
                spouse: {
                    name: 'Mrs. Deepkiran Kaur',
                    email: 'deepkirankaur23@gmail.com',
                    phone: '7052615743',
                    relationship: 'Spouse'
                }
            };
            
            // ===========================================
            // LOAD USER DATA FROM SESSION STORAGE
            // ===========================================
            // Retrieve user information from localStorage (set during login).
            // If no data found, use default user information.
            
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || JSON.stringify(defaultUserInfo));
            
            // ===========================================
            // UPDATE USER INFORMATION PANEL
            // ===========================================
            // Display user-specific information in the main user info card.
            // This includes personal details like name, designation, contact, etc.
            
            const userInfoBody = document.getElementById('userInfoBody');
            if (userInfoBody) {
                // Build HTML for user information display
                let userInfoHTML = `
                    <div class="info-row"><span class="label">User ID:</span><span class="value">${userInfo.userId}</span></div>
                    <div class="info-row"><span class="label">Name:</span><span class="value">${userInfo.name}</span></div>
                    <div class="info-row"><span class="label">Designation:</span><span class="value">${userInfo.designation || 'N/A'}</span></div>
                    <div class="info-row"><span class="label">Contact Number:</span><span class="value">${userInfo.phone || 'N/A'}</span></div>
                    <div class="info-row"><span class="label">User Type:</span><span class="value">${userInfo.userType || 'admin'}</span></div>
                `;
                
                // Insert the HTML into the user information panel
                userInfoBody.innerHTML = userInfoHTML;
            }
            
            // ===========================================
            // APPLY CONSISTENT STYLING TO USER INFO CARD
            // ===========================================
            // Apply the orange theme styling to the user information card for all users.
            // This creates a consistent visual experience across different user types.
            
            const userInfoPanel = userInfoBody.closest('.panel-card');
            if (userInfoPanel) {
                // Apply the data attribute that triggers orange theme CSS styling
                userInfoPanel.setAttribute('data-wife-details', 'true');
            }
            
            // ===========================================
            // SPOUSE INFORMATION DISPLAY LOGIC
            // ===========================================
            // This section handles the conditional display of spouse information.
            // Only users with spouse data (like Col Tarunpreet Singh) will see spouse details.
            // Other users will see a generic "Additional Details" section.
            
            const additionalDetailsTitle = document.getElementById('additionalDetailsTitle');
            const additionalDetailsBody = document.getElementById('additionalDetailsBody');
            
            // ===========================================
            // CHECK FOR SPOUSE INFORMATION
            // ===========================================
            // Only display spouse information if user has spouse data
            // Currently only Col Tarunpreet Singh has spouse information
            
            if (userInfo.hasSpouse && userInfo.spouse) {
                // ===========================================
                // SPOUSE PROFILE DISPLAY
                // ===========================================
                // User has spouse information - display spouse profile
                
                // Update section title to indicate spouse information
                additionalDetailsTitle.textContent = 'Spouse Profile';
                
                // Add spouse image to the header for visual appeal
                const additionalDetailsImage = document.getElementById('additionalDetailsImage');
                const wifeImage = document.getElementById('wifeImage');
                if (additionalDetailsImage && wifeImage) {
                    wifeImage.src = 'public/Gemini_Generated_Image_rwk0q2rwk0q2rwk0.png';
                    additionalDetailsImage.style.display = 'block';
                }
                
                // Apply orange theme styling to match user info card
                const additionalDetailsPanel = additionalDetailsTitle.closest('.panel-card');
                if (additionalDetailsPanel) {
                    additionalDetailsPanel.setAttribute('data-wife-details', 'true');
                }
                
                // Display spouse information dynamically from user data
                additionalDetailsBody.innerHTML = `
                    <div class="info-row"><span class="label">Name:</span><span class="value">${userInfo.spouse.name}</span></div>
                    <div class="info-row"><span class="label">Email:</span><span class="value">${userInfo.spouse.email}</span></div>
                    <div class="info-row"><span class="label">Contact:</span><span class="value">${userInfo.spouse.phone}</span></div>
                    <div class="info-row"><span class="label">Relationship:</span><span class="value">${userInfo.spouse.relationship}</span></div>
                `;
            } else {
                // ===========================================
                // DEFAULT ADDITIONAL DETAILS DISPLAY
                // ===========================================
                // User has no spouse information - show generic additional details
                
                // Keep default title for users without spouse information
                additionalDetailsTitle.textContent = 'Additional Details';
                
                // Hide spouse image since no spouse information is available
                const additionalDetailsImage = document.getElementById('additionalDetailsImage');
                if (additionalDetailsImage) {
                    additionalDetailsImage.style.display = 'none';
                }
                
                // Remove orange theme styling for users without spouse information
                const additionalDetailsPanel = additionalDetailsTitle.closest('.panel-card');
                if (additionalDetailsPanel) {
                    additionalDetailsPanel.removeAttribute('data-wife-details');
                }
                
                // Display generic message for users without additional details
                additionalDetailsBody.innerHTML = '<div class="empty-message">No additional details available</div>';
            }
            
            // ===========================================
            // UPDATE WELCOME MESSAGE
            // ===========================================
            // Personalize the welcome message with the user's actual name
            // This creates a more engaging and personalized user experience
            
            const welcomeTitle = document.getElementById('welcomeTitle');
            if (welcomeTitle) {
                welcomeTitle.textContent = `Welcome, ${userInfo.name}!`;
            }
        
            // ===========================================
            // UPDATE PROFILE INFORMATION
            // ===========================================
            // Update the profile card with user-specific information
            // This includes the user's name and designation for quick reference
            
            const profileName = document.getElementById('profileName');
            const profileDesignation = document.getElementById('profileDesignation');
            if (profileName) profileName.textContent = userInfo.name;
            if (profileDesignation) profileDesignation.textContent = userInfo.designation || 'User';
        
            // ===========================================
            // UPDATE PROFILE INITIALS (FALLBACK)
            // ===========================================
            // Generate initials from the user's name as a fallback display
            // This is shown when the profile image fails to load
            // Format: First letter of each name part (e.g., "Col Tarunpreet Singh" → "CTS")
            
            const profileInitials = document.getElementById('profileInitials');
            if (profileInitials) {
        const initials = userInfo.name.split(' ').map(n => n[0]).join('').toUpperCase();
                profileInitials.textContent = initials;
            }
            
            // ===========================================
            // UPDATE LEFT PANEL INFORMATION
            // ===========================================
            // Update the left navigation panel with user-specific information
            // This provides consistent user identification throughout the interface
            
            const leftPanelName = document.querySelector('.lp-name');
            const leftPanelRole = document.querySelector('.lp-role');
            if (leftPanelName) leftPanelName.textContent = userInfo.name;
            if (leftPanelRole) leftPanelRole.textContent = userInfo.designation || 'User';
        
        // Set profile image based on user
            let profileImage = 'public/profile.png';
        switch(userInfo.userId) {
            case 'tarunpreet singh':
                profileImage = 'public/Gemini_Generated_Image_4jitd24jitd24jit.png';
                break;
            case 'piyush sharma':
                profileImage = 'public/Gemini_Generated_Image_iy5po1iy5po1iy5p.png';
                break;
            case 'harish kumar':
                    profileImage = 'public/Gemini_Generated_Image_kd3igrkd3igrkd3i (1).png';
                break;
            case 'rahul t more':
                profileImage = 'public/Col.jpg';
                break;
            case 'bt01':
                profileImage = 'public/profile.png';
                break;
            default:
                profileImage = 'public/profile.png';
        }
        
        // Update profile images
        const profileImages = document.querySelectorAll('.avatar-box-img, .lp-avatar-img');
        profileImages.forEach(img => {
            img.src = profileImage;
        });
        }

// Logout function
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('userInfo');
        window.location.href = 'login.html';
    }
}

        // Load user info when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            
            // Initialize navigation state on page load
            const lpNav = document.getElementById('lpNav');
            const navToggle = document.getElementById('navToggle');
            const leftPanel = document.querySelector('.left-panel');
            
            if (window.innerWidth <= 768) {
                // Mobile view - start with collapsed navigation
                lpNav.classList.add('collapsed');
                navToggle.style.display = 'block';
            } else {
                // Desktop view - always show navigation
                lpNav.classList.remove('collapsed', 'expanded');
                navToggle.style.display = 'none';
            }
            
            // Handle window resize for responsive behavior
            window.addEventListener('resize', function() {
                if (window.innerWidth <= 768) {
                    // Mobile view
                    navToggle.style.display = 'block';
                } else {
                    // Desktop view
                    navToggle.style.display = 'none';
                    lpNav.classList.remove('collapsed', 'expanded');
                    // Close mobile menu if open
                    closeMobileMenu();
                }
            });
            
            // Add keyboard support for mobile menu
            document.addEventListener('keydown', function(e) {
                const mobileNavPopup = document.getElementById('mobileNavPopup');
                if (e.key === 'Escape' && !mobileNavPopup.classList.contains('hidden')) {
                    closeMobileMenu();
                }
            });
            
            // Prevent body scroll when mobile menu is open
            const mobileNavPopup = document.getElementById('mobileNavPopup');
            mobileNavPopup.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
        });

        // Mobile Menu Toggle Functionality
        function toggleMobileMenu() {
            const mobileNavPopup = document.getElementById('mobileNavPopup');
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const icon = mobileMenuToggle.querySelector('i');
            
            if (mobileNavPopup.classList.contains('hidden')) {
                // Open mobile menu
                mobileNavPopup.classList.remove('hidden');
                icon.className = 'fas fa-times';
                document.body.style.overflow = 'hidden'; // Prevent scrolling
                console.log('Mobile menu opened');
            } else {
                // Close mobile menu
                mobileNavPopup.classList.add('hidden');
                icon.className = 'fas fa-bars';
                document.body.style.overflow = ''; // Restore scrolling
                console.log('Mobile menu closed');
            }
        }
        
        // Close Mobile Menu
        function closeMobileMenu() {
            const mobileNavPopup = document.getElementById('mobileNavPopup');
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const icon = mobileMenuToggle.querySelector('i');
            
            mobileNavPopup.classList.add('hidden');
            icon.className = 'fas fa-bars';
            document.body.style.overflow = ''; // Restore scrolling
            console.log('Mobile menu closed');
        }
        
        // Navigate to Section (Mobile)
        function navigateToSection(sectionId) {
            // Close mobile menu first
            closeMobileMenu();
            
            // Update active states
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            mobileNavItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-target') === sectionId) {
                    item.classList.add('active');
                }
            });
            
            // Update desktop navigation active states
            const desktopNavItems = document.querySelectorAll('.lp-nav li');
            desktopNavItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-target') === sectionId) {
                    item.classList.add('active');
                }
            });
            
            // Show the target section
            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            console.log('Navigated to:', sectionId);
        }
        
        // Sidebar Toggle Functionality
        function toggleSidebar() {
            const leftPanel = document.querySelector('.left-panel');
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            const icon = sidebarToggleBtn.querySelector('i');
            
            if (leftPanel.classList.contains('collapsed')) {
                // Expand sidebar
                leftPanel.classList.remove('collapsed');
                icon.className = 'fas fa-arrow-right';
                console.log('Sidebar expanded');
            } else {
                // Collapse sidebar
                leftPanel.classList.add('collapsed');
                icon.className = 'fas fa-arrow-left';
                console.log('Sidebar collapsed');
            }
        }

        // Navigation toggle functionality - TO BE FIXED BY JYOTI
        // Current implementation has issues with button visibility and functionality
        function toggleNavigation() {
            console.log('Toggle navigation clicked');
            const navToggle = document.getElementById('navToggle');
            const lpNav = document.getElementById('lpNav');
            const icon = navToggle.querySelector('i');
            const text = navToggle.querySelector('span');
            
            console.log('Current nav state:', lpNav.classList.contains('expanded') ? 'expanded' : 'collapsed');
            
            if (lpNav.classList.contains('expanded')) {
                // Collapse navigation
                lpNav.classList.remove('expanded');
                lpNav.classList.add('collapsed');
                icon.className = 'fas fa-chevron-down';
                text.textContent = 'Menu';
                navToggle.classList.remove('active');
                console.log('Navigation collapsed');
            } else {
                // Expand navigation
                lpNav.classList.remove('collapsed');
                lpNav.classList.add('expanded');
                icon.className = 'fas fa-chevron-up';
                text.textContent = 'Close';
                navToggle.classList.add('active');
                console.log('Navigation expanded');
            }
        }

        // Auto-collapse navigation on mobile when clicking outside
        document.addEventListener('click', function(event) {
            const navToggle = document.getElementById('navToggle');
            const lpNav = document.getElementById('lpNav');
            const leftPanel = document.querySelector('.left-panel');
            
            // Check if we're on mobile (screen width <= 768px)
            if (window.innerWidth <= 768) {
                // If click is outside the left panel and navigation is expanded
                if (!leftPanel.contains(event.target) && lpNav.classList.contains('expanded')) {
                    lpNav.classList.remove('expanded');
                    lpNav.classList.add('collapsed');
                    const icon = navToggle.querySelector('i');
                    const text = navToggle.querySelector('span');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                    text.textContent = 'Menu';
                    navToggle.classList.remove('active');
                }
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            const lpNav = document.getElementById('lpNav');
            const navToggle = document.getElementById('navToggle');
            
            if (window.innerWidth > 768) {
                // Desktop view - always show navigation
                lpNav.classList.remove('collapsed', 'expanded');
                navToggle.style.display = 'none';
            } else {
                // Mobile view - show toggle button
                navToggle.style.display = 'block';
                if (!lpNav.classList.contains('expanded')) {
                    lpNav.classList.add('collapsed');
                }
            }
        });
</script>
</body>
</html>

